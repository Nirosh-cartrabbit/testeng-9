var ka=Object.defineProperty;var Ca=(H,X,le)=>X in H?ka(H,X,{enumerable:!0,configurable:!0,writable:!0,value:le}):H[X]=le;var F=(H,X,le)=>(Ca(H,typeof X!="symbol"?X+"":X,le),le);(function(){var Ft,Rt;"use strict";const me=class me{constructor(){F(this,"states",{})}static getInstance(){return me.instance||(me.instance=new me),me.instance}setState(e,t){this.states[e]=t}getState(e){return this.states[e]}};F(me,"instance",null);let H=me;class X{constructor(){F(this,"baseUrl","http://localhost:3000/");F(this,"defaultHeader",{"Content-Type":"application/json"})}async get(e,t){let n=this.baseUrl+e;t&&t.baseUrl&&(n=t.baseUrl+e);const a=await fetch(n,{headers:this.defaultHeader,...t&&{...t}});return{data:await a.json(),status:a.status}}async post(e,t,n){let a=this.baseUrl+e;n&&n.baseUrl&&(a=n.baseUrl+e);const s=await fetch(a,{headers:this.defaultHeader,...n&&{...n},method:"POST",body:typeof t=="string"?t:JSON.stringify(t)});return{data:await s.json(),status:s.status}}}function le(r,e){let t;try{t=r()}catch{return}return{getItem:a=>{var s;const u=p=>p===null?null:JSON.parse(p,e==null?void 0:e.reviver),h=(s=t.getItem(a))!=null?s:null;return h instanceof Promise?h.then(u):u(h)},setItem:(a,s)=>t.setItem(a,JSON.stringify(s,e==null?void 0:e.replacer)),removeItem:a=>t.removeItem(a)}}const _e=r=>e=>{try{const t=r(e);return t instanceof Promise?t:{then(n){return _e(n)(t)},catch(n){return this}}}catch(t){return{then(n){return this},catch(n){return _e(n)(t)}}}},Mt=(r,e)=>(t,n,a)=>{let s={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:E=>E,version:0,merge:(E,j)=>({...j,...E}),...e},u=!1;const h=new Set,p=new Set;let _;try{_=s.getStorage()}catch{}if(!_)return r((...E)=>{console.warn(`[zustand persist middleware] Unable to update item '${s.name}', the given storage is currently unavailable.`),t(...E)},n,a);const A=_e(s.serialize),P=()=>{const E=s.partialize({...n()});let j;const O=A({state:E,version:s.version}).then(R=>_.setItem(s.name,R)).catch(R=>{j=R});if(j)throw j;return O},w=a.setState;a.setState=(E,j)=>{w(E,j),P()};const S=r((...E)=>{t(...E),P()},n,a);let T;const g=()=>{var E;if(!_)return;u=!1,h.forEach(O=>O(n()));const j=((E=s.onRehydrateStorage)==null?void 0:E.call(s,n()))||void 0;return _e(_.getItem.bind(_))(s.name).then(O=>{if(O)return s.deserialize(O)}).then(O=>{if(O)if(typeof O.version=="number"&&O.version!==s.version){if(s.migrate)return s.migrate(O.state,O.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return O.state}).then(O=>{var R;return T=s.merge(O,(R=n())!=null?R:S),t(T,!0),P()}).then(()=>{j==null||j(T,void 0),u=!0,p.forEach(O=>O(T))}).catch(O=>{j==null||j(void 0,O)})};return a.persist={setOptions:E=>{s={...s,...E},E.getStorage&&(_=E.getStorage())},clearStorage:()=>{_==null||_.removeItem(s.name)},getOptions:()=>s,rehydrate:()=>g(),hasHydrated:()=>u,onHydrate:E=>(h.add(E),()=>{h.delete(E)}),onFinishHydration:E=>(p.add(E),()=>{p.delete(E)})},g(),T||S},Nt=(r,e)=>(t,n,a)=>{let s={storage:le(()=>localStorage),partialize:g=>g,version:0,merge:(g,E)=>({...E,...g}),...e},u=!1;const h=new Set,p=new Set;let _=s.storage;if(!_)return r((...g)=>{console.warn(`[zustand persist middleware] Unable to update item '${s.name}', the given storage is currently unavailable.`),t(...g)},n,a);const A=()=>{const g=s.partialize({...n()});return _.setItem(s.name,{state:g,version:s.version})},P=a.setState;a.setState=(g,E)=>{P(g,E),A()};const w=r((...g)=>{t(...g),A()},n,a);let S;const T=()=>{var g,E;if(!_)return;u=!1,h.forEach(O=>{var R;return O((R=n())!=null?R:w)});const j=((E=s.onRehydrateStorage)==null?void 0:E.call(s,(g=n())!=null?g:w))||void 0;return _e(_.getItem.bind(_))(s.name).then(O=>{if(O)if(typeof O.version=="number"&&O.version!==s.version){if(s.migrate)return s.migrate(O.state,O.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return O.state}).then(O=>{var R;return S=s.merge(O,(R=n())!=null?R:w),t(S,!0),A()}).then(()=>{j==null||j(S,void 0),S=n(),u=!0,p.forEach(O=>O(S))}).catch(O=>{j==null||j(void 0,O)})};return a.persist={setOptions:g=>{s={...s,...g},g.storage&&(_=g.storage)},clearStorage:()=>{_==null||_.removeItem(s.name)},getOptions:()=>s,rehydrate:()=>T(),hasHydrated:()=>u,onHydrate:g=>(h.add(g),()=>{h.delete(g)}),onFinishHydration:g=>(p.add(g),()=>{p.delete(g)})},s.skipHydration||T(),S||w},nt=(r,e)=>"getStorage"in e||"serialize"in e||"deserialize"in e?Mt(r,e):Nt(r,e),at=r=>{let e;const t=new Set,n=(p,_)=>{const A=typeof p=="function"?p(e):p;if(!Object.is(A,e)){const P=e;e=_??(typeof A!="object"||A===null)?A:Object.assign({},e,A),t.forEach(w=>w(e,P))}},a=()=>e,h={setState:n,getState:a,subscribe:p=>(t.add(p),()=>t.delete(p)),destroy:()=>{t.clear()}};return e=r(n,a,h),h},it=r=>r?at(r):at,Lt={store:{user:{},phases:{},currentPhase:"",rules:{},triggers:{},lastSeen:0,totalSeen:0,isClosed:!1}},Dt={country:"",country_code:"",first_visit_date:"",first_visit_time:"",isNewUser:"",language:"",timeZone:""},Ut=r=>it()(nt(()=>({...Lt}),{name:r})),Bt=it()(nt(()=>({...Dt}),{name:"retainful-attributes"})),xt={"Europe/Andorra":"Andorra","Asia/Dubai":"United Arab Emirates","Asia/Kabul":"Afghanistan","Europe/Tirane":"Albania","Asia/Yerevan":"Armenia","Antarctica/Casey":"Antarctica","Antarctica/Davis":"Antarctica","Antarctica/Mawson":"Antarctica","Antarctica/Palmer":"Antarctica","Antarctica/Rothera":"Antarctica","Antarctica/Troll":"Antarctica","Antarctica/Vostok":"Antarctica","America/Argentina/Buenos_Aires":"Argentina","America/Argentina/Cordoba":"Argentina","America/Argentina/Salta":"Argentina","America/Argentina/Jujuy":"Argentina","America/Argentina/Tucuman":"Argentina","America/Argentina/Catamarca":"Argentina","America/Argentina/La_Rioja":"Argentina","America/Argentina/San_Juan":"Argentina","America/Argentina/Mendoza":"Argentina","America/Argentina/San_Luis":"Argentina","America/Argentina/Rio_Gallegos":"Argentina","America/Argentina/Ushuaia":"Argentina","Pacific/Pago_Pago":"Samoa (American)","Europe/Vienna":"Austria","Australia/Lord_Howe":"Australia","Antarctica/Macquarie":"Australia","Australia/Hobart":"Australia","Australia/Melbourne":"Australia","Australia/Sydney":"Australia","Australia/Broken_Hill":"Australia","Australia/Brisbane":"Australia","Australia/Lindeman":"Australia","Australia/Adelaide":"Australia","Australia/Darwin":"Australia","Australia/Perth":"Australia","Australia/Eucla":"Australia","Asia/Baku":"Azerbaijan","America/Barbados":"Barbados","Asia/Dhaka":"Bangladesh","Europe/Brussels":"Belgium","Europe/Sofia":"Bulgaria","Atlantic/Bermuda":"Bermuda","Asia/Brunei":"Brunei","America/La_Paz":"Bolivia","America/Noronha":"Brazil","America/Belem":"Brazil","America/Fortaleza":"Brazil","America/Recife":"Brazil","America/Araguaina":"Brazil","America/Maceio":"Brazil","America/Bahia":"Brazil","America/Sao_Paulo":"Brazil","America/Campo_Grande":"Brazil","America/Cuiaba":"Brazil","America/Santarem":"Brazil","America/Porto_Velho":"Brazil","America/Boa_Vista":"Brazil","America/Manaus":"Brazil","America/Eirunepe":"Brazil","America/Rio_Branco":"Brazil","Asia/Thimphu":"Bhutan","Europe/Minsk":"Belarus","America/Belize":"Belize","America/St_Johns":"Canada","America/Halifax":"Canada","America/Glace_Bay":"Canada","America/Moncton":"Canada","America/Goose_Bay":"Canada","America/Toronto":"Canada","America/Nipigon":"Canada","America/Thunder_Bay":"Canada","America/Iqaluit":"Canada","America/Pangnirtung":"Canada","America/Winnipeg":"Canada","America/Rainy_River":"Canada","America/Resolute":"Canada","America/Rankin_Inlet":"Canada","America/Regina":"Canada","America/Swift_Current":"Canada","America/Edmonton":"Canada","America/Cambridge_Bay":"Canada","America/Yellowknife":"Canada","America/Inuvik":"Canada","America/Dawson_Creek":"Canada","America/Fort_Nelson":"Canada","America/Whitehorse":"Canada","America/Dawson":"Canada","America/Vancouver":"Canada","Indian/Cocos":"Cocos (Keeling) Islands","Europe/Zurich":"Switzerland","Africa/Abidjan":"Côte d'Ivoire","Pacific/Rarotonga":"Cook Islands","America/Santiago":"Chile","America/Punta_Arenas":"Chile","Pacific/Easter":"Chile","Asia/Shanghai":"China","Asia/Urumqi":"China","America/Bogota":"Colombia","America/Costa_Rica":"Costa Rica","America/Havana":"Cuba","Atlantic/Cape_Verde":"Cape Verde","Indian/Christmas":"Christmas Island","Asia/Nicosia":"Cyprus","Asia/Famagusta":"Cyprus","Europe/Prague":"Czech Republic","Europe/Berlin":"Germany","Europe/Copenhagen":"Denmark","America/Santo_Domingo":"Dominican Republic","Africa/Algiers":"Algeria","America/Guayaquil":"Ecuador","Pacific/Galapagos":"Ecuador","Europe/Tallinn":"Estonia","Africa/Cairo":"Egypt","Africa/El_Aaiun":"Western Sahara","Europe/Madrid":"Spain","Africa/Ceuta":"Spain","Atlantic/Canary":"Spain","Europe/Helsinki":"Finland","Pacific/Fiji":"Fiji","Atlantic/Stanley":"Falkland Islands","Pacific/Chuuk":"Micronesia","Pacific/Pohnpei":"Micronesia","Pacific/Kosrae":"Micronesia","Atlantic/Faroe":"Faroe Islands","Europe/Paris":"France","Europe/London":"Britain (UK)","Asia/Tbilisi":"Georgia","America/Cayenne":"French Guiana","Europe/Gibraltar":"Gibraltar","America/Nuuk":"Greenland","America/Danmarkshavn":"Greenland","America/Scoresbysund":"Greenland","America/Thule":"Greenland","Europe/Athens":"Greece","Atlantic/South_Georgia":"South Georgia & the South Sandwich Islands","America/Guatemala":"Guatemala","Pacific/Guam":"Guam","Africa/Bissau":"Guinea-Bissau","America/Guyana":"Guyana","Asia/Hong_Kong":"Hong Kong","America/Tegucigalpa":"Honduras","America/Port-au-Prince":"Haiti","Europe/Budapest":"Hungary","Asia/Jakarta":"Indonesia","Asia/Pontianak":"Indonesia","Asia/Makassar":"Indonesia","Asia/Jayapura":"Indonesia","Europe/Dublin":"Ireland","Asia/Jerusalem":"Israel","Asia/Kolkata":"India","Asia/Calcutta":"India","Indian/Chagos":"British Indian Ocean Territory","Asia/Baghdad":"Iraq","Asia/Tehran":"Iran","Atlantic/Reykjavik":"Iceland","Europe/Rome":"Italy","America/Jamaica":"Jamaica","Asia/Amman":"Jordan","Asia/Tokyo":"Japan","Africa/Nairobi":"Kenya","Asia/Bishkek":"Kyrgyzstan","Pacific/Tarawa":"Kiribati","Pacific/Kanton":"Kiribati","Pacific/Kiritimati":"Kiribati","Asia/Pyongyang":"Korea (North)","Asia/Seoul":"Korea (South)","Asia/Almaty":"Kazakhstan","Asia/Qyzylorda":"Kazakhstan","Asia/Qostanay":"Kazakhstan","Asia/Aqtobe":"Kazakhstan","Asia/Aqtau":"Kazakhstan","Asia/Atyrau":"Kazakhstan","Asia/Oral":"Kazakhstan","Asia/Beirut":"Lebanon","Asia/Colombo":"Sri Lanka","Africa/Monrovia":"Liberia","Europe/Vilnius":"Lithuania","Europe/Luxembourg":"Luxembourg","Europe/Riga":"Latvia","Africa/Tripoli":"Libya","Africa/Casablanca":"Morocco","Europe/Monaco":"Monaco","Europe/Chisinau":"Moldova","Pacific/Majuro":"Marshall Islands","Pacific/Kwajalein":"Marshall Islands","Asia/Yangon":"Myanmar (Burma)","Asia/Ulaanbaatar":"Mongolia","Asia/Hovd":"Mongolia","Asia/Choibalsan":"Mongolia","Asia/Macau":"Macau","America/Martinique":"Martinique","Europe/Malta":"Malta","Indian/Mauritius":"Mauritius","Indian/Maldives":"Maldives","America/Mexico_City":"Mexico","America/Cancun":"Mexico","America/Merida":"Mexico","America/Monterrey":"Mexico","America/Matamoros":"Mexico","America/Mazatlan":"Mexico","America/Chihuahua":"Mexico","America/Ojinaga":"Mexico","America/Hermosillo":"Mexico","America/Tijuana":"Mexico","America/Bahia_Banderas":"Mexico","Asia/Kuala_Lumpur":"Malaysia","Asia/Kuching":"Malaysia","Africa/Maputo":"Mozambique","Africa/Windhoek":"Namibia","Pacific/Noumea":"New Caledonia","Pacific/Norfolk":"Norfolk Island","Africa/Lagos":"Nigeria","America/Managua":"Nicaragua","Europe/Amsterdam":"Netherlands","Europe/Oslo":"Norway","Asia/Kathmandu":"Nepal","Pacific/Nauru":"Nauru","Pacific/Niue":"Niue","Pacific/Auckland":"New Zealand","Pacific/Chatham":"New Zealand","America/Panama":"Panama","America/Lima":"Peru","Pacific/Tahiti":"French Polynesia","Pacific/Marquesas":"French Polynesia","Pacific/Gambier":"French Polynesia","Pacific/Port_Moresby":"Papua New Guinea","Pacific/Bougainville":"Papua New Guinea","Asia/Manila":"Philippines","Asia/Karachi":"Pakistan","Europe/Warsaw":"Poland","America/Miquelon":"St Pierre & Miquelon","Pacific/Pitcairn":"Pitcairn","America/Puerto_Rico":"Puerto Rico","Asia/Gaza":"Palestine","Asia/Hebron":"Palestine","Europe/Lisbon":"Portugal","Atlantic/Madeira":"Portugal","Atlantic/Azores":"Portugal","Pacific/Palau":"Palau","America/Asuncion":"Paraguay","Asia/Qatar":"Qatar","Indian/Reunion":"Réunion","Europe/Bucharest":"Romania","Europe/Belgrade":"Serbia","Europe/Kaliningrad":"Russia","Europe/Moscow":"Russia","Europe/Simferopol":"Russia","Europe/Kirov":"Russia","Europe/Volgograd":"Russia","Europe/Astrakhan":"Russia","Europe/Saratov":"Russia","Europe/Ulyanovsk":"Russia","Europe/Samara":"Russia","Asia/Yekaterinburg":"Russia","Asia/Omsk":"Russia","Asia/Novosibirsk":"Russia","Asia/Barnaul":"Russia","Asia/Tomsk":"Russia","Asia/Novokuznetsk":"Russia","Asia/Krasnoyarsk":"Russia","Asia/Irkutsk":"Russia","Asia/Chita":"Russia","Asia/Yakutsk":"Russia","Asia/Khandyga":"Russia","Asia/Vladivostok":"Russia","Asia/Ust-Nera":"Russia","Asia/Magadan":"Russia","Asia/Sakhalin":"Russia","Asia/Srednekolymsk":"Russia","Asia/Kamchatka":"Russia","Asia/Anadyr":"Russia","Asia/Riyadh":"Saudi Arabia","Pacific/Guadalcanal":"Solomon Islands","Indian/Mahe":"Seychelles","Africa/Khartoum":"Sudan","Europe/Stockholm":"Sweden","Asia/Singapore":"Singapore","America/Paramaribo":"Suriname","Africa/Juba":"South Sudan","Africa/Sao_Tome":"Sao Tome & Principe","America/El_Salvador":"El Salvador","Asia/Damascus":"Syria","America/Grand_Turk":"Turks & Caicos Is","Africa/Ndjamena":"Chad","Indian/Kerguelen":"French Southern & Antarctic Lands","Asia/Bangkok":"Thailand","Asia/Dushanbe":"Tajikistan","Pacific/Fakaofo":"Tokelau","Asia/Dili":"East Timor","Asia/Ashgabat":"Turkmenistan","Africa/Tunis":"Tunisia","Pacific/Tongatapu":"Tonga","Europe/Istanbul":"Turkey","Pacific/Funafuti":"Tuvalu","Asia/Taipei":"Taiwan","Europe/Kiev":"Ukraine","Europe/Uzhgorod":"Ukraine","Europe/Zaporozhye":"Ukraine","Pacific/Wake":"US minor outlying islands","America/New_York":"United States","America/Detroit":"United States","America/Kentucky/Louisville":"United States","America/Kentucky/Monticello":"United States","America/Indiana/Indianapolis":"United States","America/Indiana/Vincennes":"United States","America/Indiana/Winamac":"United States","America/Indiana/Marengo":"United States","America/Indiana/Petersburg":"United States","America/Indiana/Vevay":"United States","America/Chicago":"United States","America/Indiana/Tell_City":"United States","America/Indiana/Knox":"United States","America/Menominee":"United States","America/North_Dakota/Center":"United States","America/North_Dakota/New_Salem":"United States","America/North_Dakota/Beulah":"United States","America/Denver":"United States","America/Boise":"United States","America/Phoenix":"United States","America/Los_Angeles":"United States","America/Anchorage":"United States","America/Juneau":"United States","America/Sitka":"United States","America/Metlakatla":"United States","America/Yakutat":"United States","America/Nome":"United States","America/Adak":"United States","Pacific/Honolulu":"United States","America/Montevideo":"Uruguay","Asia/Samarkand":"Uzbekistan","Asia/Tashkent":"Uzbekistan","America/Caracas":"Venezuela","Asia/Ho_Chi_Minh":"Vietnam","Pacific/Efate":"Vanuatu","Pacific/Wallis":"Wallis & Futuna","Pacific/Apia":"Samoa (western)","Africa/Johannesburg":"South Africa","America/Antigua":"Antigua & Barbuda","America/Anguilla":"Anguilla","Africa/Luanda":"Angola","Antarctica/McMurdo":"Antarctica","Antarctica/DumontDUrville":"Antarctica","Antarctica/Syowa":"Antarctica","America/Aruba":"Aruba","Europe/Mariehamn":"Åland Islands","Europe/Sarajevo":"Bosnia & Herzegovina","Africa/Ouagadougou":"Burkina Faso","Asia/Bahrain":"Bahrain","Africa/Bujumbura":"Burundi","Africa/Porto-Novo":"Benin","America/St_Barthelemy":"St Barthelemy","America/Kralendijk":"Caribbean NL","America/Nassau":"Bahamas","Africa/Gaborone":"Botswana","America/Blanc-Sablon":"Canada","America/Atikokan":"Canada","America/Creston":"Canada","Africa/Kinshasa":"Congo (Dem. Rep.)","Africa/Lubumbashi":"Congo (Dem. Rep.)","Africa/Bangui":"Central African Rep.","Africa/Brazzaville":"Congo (Rep.)","Africa/Douala":"Cameroon","America/Curacao":"Curaçao","Europe/Busingen":"Germany","Africa/Djibouti":"Djibouti","America/Dominica":"Dominica","Africa/Asmara":"Eritrea","Africa/Addis_Ababa":"Ethiopia","Africa/Libreville":"Gabon","America/Grenada":"Grenada","Europe/Guernsey":"Guernsey","Africa/Accra":"Ghana","Africa/Banjul":"Gambia","Africa/Conakry":"Guinea","America/Guadeloupe":"Guadeloupe","Africa/Malabo":"Equatorial Guinea","Europe/Zagreb":"Croatia","Europe/Isle_of_Man":"Isle of Man","Europe/Jersey":"Jersey","Asia/Phnom_Penh":"Cambodia","Indian/Comoro":"Comoros","America/St_Kitts":"St Kitts & Nevis","Asia/Kuwait":"Kuwait","America/Cayman":"Cayman Islands","Asia/Vientiane":"Laos","America/St_Lucia":"St Lucia","Europe/Vaduz":"Liechtenstein","Africa/Maseru":"Lesotho","Europe/Podgorica":"Montenegro","America/Marigot":"St Martin (French)","Indian/Antananarivo":"Madagascar","Europe/Skopje":"North Macedonia","Africa/Bamako":"Mali","Pacific/Saipan":"Northern Mariana Islands","Africa/Nouakchott":"Mauritania","America/Montserrat":"Montserrat","Africa/Blantyre":"Malawi","Africa/Niamey":"Niger","Asia/Muscat":"Oman","Africa/Kigali":"Rwanda","Atlantic/St_Helena":"St Helena","Europe/Ljubljana":"Slovenia","Arctic/Longyearbyen":"Svalbard & Jan Mayen","Europe/Bratislava":"Slovakia","Africa/Freetown":"Sierra Leone","Europe/San_Marino":"San Marino","Africa/Dakar":"Senegal","Africa/Mogadishu":"Somalia","America/Lower_Princes":"St Maarten (Dutch)","Africa/Mbabane":"Eswatini (Swaziland)","Africa/Lome":"Togo","America/Port_of_Spain":"Trinidad & Tobago","Africa/Dar_es_Salaam":"Tanzania","Africa/Kampala":"Uganda","Pacific/Midway":"US minor outlying islands","Europe/Vatican":"Vatican City","America/St_Vincent":"St Vincent","America/Tortola":"Virgin Islands (UK)","America/St_Thomas":"Virgin Islands (US)","Asia/Aden":"Yemen","Indian/Mayotte":"Mayotte","Africa/Lusaka":"Zambia","Africa/Harare":"Zimbabwe"},$t=r=>{let e={};for(let t=0,n=r.attributes,a=n.length;t<a;t++){const s=n[t].nodeName.replace("data-","").replace("customer-","").replace("-","_");e[s]=n[t].nodeValue}return e},zt=r=>{try{return typeof r!="string"?r:JSON.parse(r)}catch{return{}}},Ht=(r,e)=>{try{return Object.assign(r,e)}catch{}},Vt=r=>{var n;const t=new DOMParser().parseFromString(r,"text/html");try{return(n=t.body)==null?void 0:n.firstElementChild}catch{console.warn("Error parsing")}};function st(r,e,t){const n=new Date;n.setTime(n.getTime()+t*24*60*60*1e3);const a="expires="+n.toUTCString();document.cookie=r+"="+e+";"+a+";path=/"}function ot(r){var n;const t=("; "+document.cookie).split("; "+r+"=");return t.length==2?(n=t.pop())==null?void 0:n.split(";").shift():""}const Re=()=>{if(!Intl)return null;const r=Intl.DateTimeFormat().resolvedOptions(),e=Intl.DateTimeFormat().resolvedOptions().timeZone,t=e.split("/"),n=t[0],a=t[t.length-1];return{userCountry:xt[e],userRegion:n,userCity:a,options:{...r}}},ut=()=>{const r=navigator.languages&&navigator.languages.length?navigator.languages:[navigator.language],e=new Intl.DisplayNames(r,{type:"language"}),t=r[0];return e.of(t)},Gt=()=>{const r=ot("rtl-gid")?"returning-user":"new-user";return r==="new-user"&&st("rtl-gid",`${Math.floor(Math.random()*100)}:${Date.now()}`,30),r},ee=r=>r?typeof r=="string"||Array.isArray(r)?r.length===0:Object.keys(r).length===0:!1;class qt{constructor(){F(this,"http",new X);F(this,"popupData",{});F(this,"mainStore",null);F(this,"appContext",H.getInstance())}async initApp(){var e;try{if(!this.isAppPopupEnabled())throw new Error("App is not enabled");const t=this.getAppDetails(),n=this.validateCred(t);if(n===!1)throw new Error("Credentials not found");if(ee(n==null?void 0:n.app_key))throw new Error("Credentials is not valid");let a=(await zt((await this.getAppPopups(n.app_key)).data)).popups;if(ee(a))throw new Error("Popup data is empty");((e=a==null?void 0:a.campaigns)==null?void 0:e.length)===1&&(a=a.campaigns[0]),window.RetainfulPopup=a,this.setUpAppUserAttributes(),this.popupData={campaigns:a}}catch(t){throw console.error(t),null}}isAppPopupEnabled(){return this.appElement()?!0:(console.warn("App is not initialized for this shop."),!1)}getApp(){if(this.isAppPopupEnabled())return this.getAppDetails()}getPopupData(){try{return ee(this.popupData)?ee(window.RetainfulPopUp)?{}:window.RetainfulPopUp:this.popupData}catch{throw null}}appElement(){return document.getElementById("rtl-shopify-init")}getAppDetails(){const e=this.appElement();let t={};return e&&(t=$t(e)),t}validateCred(e){return this.validateAppId(e.app_key||"")?e:!1}validateAppId(e){try{return!ee(e)}catch{return!0}}async getAppPopups(e){return await this.http.get(`shops/${e}/popups.json?t=${Date.now()}`,{baseUrl:"https://s3.us-east-2.amazonaws.com/popups.retainful.net/beta/"})}setUpAppUserAttributes(){this.mainStore=Bt,this.mainStore.setState(e=>{var t,n,a;return{country:((t=Re())==null?void 0:t.userCountry)||"",country_code:((n=Re())==null?void 0:n.options.locale)||"",first_visit_date:e.first_visit_date||new Date().toLocaleDateString(),first_visit_time:e.first_visit_time||`${Date.now()}`,isNewUser:Gt(),language:ut()||"",timeZone:((a=Re())==null?void 0:a.options.timeZone)||""}}),this.appContext.setState("main-state",this.mainStore)}}var Kt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Jt(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function Wt(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var a=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(t,n,a.get?a:{enumerable:!0,get:function(){return r[n]}})}),t}var Z={},ne={},we={},Be={};Object.defineProperty(Be,"__esModule",{value:!0});function Yt(r){for(var e=r.length,t=5381,n=52711,a;e--;)a=r.charCodeAt(e),t=t*33^a,n=n*33^a;return(t>>>0)*4096+(n>>>0)}var Ee="|",Zt=/\[object ([HTML|SVG](.*)Element)\]/,Qt={"[object Arguments]":0,"[object Array]":1,"[object ArrayBuffer]":2,"[object AsyncFunction]":3,"[object AsyncGeneratorFunction]":4,"[object BigInt]":5,"[object BigInt64Array]":6,"[object BigUint64Array]":7,"[object Boolean]":8,"[object DataView]":9,"[object Date]":10,"[object DocumentFragment]":11,"[object Error]":12,"[object Event]":13,"[object Float32Array]":14,"[object Float64Array]":15,"[object Function]":16,"[object Generator]":17,"[object GeneratorFunction]":18,"[object Int8Array]":19,"[object Int16Array]":20,"[object Map]":21,"[object Number]":22,"[object Object]":23,"[object Promise]":24,"[object RegExp]":25,"[object Set]":26,"[object SharedArrayBuffer]":27,"[object String]":28,"[object Uint8Array]":29,"[object Uint8ClampedArray]":30,"[object Uint16Array]":31,"[object Uint32Array]":32,"[object WeakMap]":33,"[object WeakRef]":34,"[object WeakSet]":35,CUSTOM:36,ELEMENT:37},Xt={"[object Arguments]":1,"[object Array]":2},ct={"[object Generator]":1,"[object Promise]":2,"[object WeakMap]":3,"[object WeakRef]":4,"[object WeakSet]":5},er={"[object AsyncFunction]":1,"[object AsyncGeneratorFunction]":2,"[object Boolean]":3,"[object Function]":4,"[object GeneratorFunction]":5,"[object Number]":6,"[object String]":7},tr={"[object BigInt64Array]":1,"[object BigUint64Array]":2,"[object Float32Array]":3,"[object Float64Array]":4,"[object Int8Array]":5,"[object Int16Array]":6,"[object Uint8Array]":7,"[object Uint8ClampedArray]":8,"[object Uint16Array]":9,"[object Uint32Array]":10},rr={"[object Arguments]":1,"[object Array]":2,"[object ArrayBuffer]":3,"[object BigInt64Array]":4,"[object BigUint64Array]":5,"[object DataView]":6,"[object Float32Array]":7,"[object Float64Array]":8,"[object Int8Array]":9,"[object Int16Array]":10,"[object Map]":11,"[object Object]":12,"[object Set]":13,"[object SharedArrayBuffer]":14,"[object Uint8Array]":15,"[object Uint8ClampedArray]":16,"[object Uint16Array]":17,"[object Uint32Array]":18,CUSTOM:19},Se={bigint:"i",boolean:"b",empty:"e",function:"g",number:"n",object:"o",string:"s",symbol:"s"};function nr(r,e){return r[0]>e[0]}function lt(r,e){return r>e}function xe(r,e){for(var t,n,a=0;a<r.length;++a){for(n=r[a],t=a-1;~t&&e(r[t],n);--t)r[t+1]=r[t];r[t+1]=n}return r}function V(r,e){return Se.object+Ee+Qt[r]+Ee+e}var ft=new WeakMap,ar=0;function $e(r,e){var t=ft.get(r);if(t)return t;var n=V(e,"NOT_ENUMERABLE"+Ee+ar++);return ft.set(r,n),n}var ir=Object.prototype.toString;function sr(r,e,t){if(rr[e])return ht(e,r,t);if(e==="[object Date]")return V(e,r.getTime());if(e==="[object RegExp]")return V(e,r.toString());if(e==="[object Event]")return V(e,[r.bubbles,r.cancelBubble,r.cancelable,r.composed,r.currentTarget,r.defaultPrevented,r.eventPhase,r.isTrusted,r.returnValue,r.target,r.type].join());if(e==="[object Error]")return V(e,r.message+Ee+r.stack);if(e==="[object DocumentFragment]")return V(e,fr(r));var n=e.match(Zt);return n?V("ELEMENT",n[1]+Ee+r.outerHTML):ct[e]?$e(r,e):er[e]?V(e,r.toString()):ht("CUSTOM",r,t)}function ht(r,e,t){var n=t.cache.get(e);return n?V(r,"RECURSIVE~"+n):(t.cache.set(e,++t.id),r==="[object Object]"?e[Symbol.iterator]?$e(e,r):V(r,pt(e,t)):Xt[r]?V(r,or(e,t)):r==="[object Map]"?V(r,hr(e,t)):r==="[object Set]"?V(r,dr(e,t)):tr[r]?V(r,e.join()):r==="[object ArrayBuffer]"?V(r,dt(e)):r==="[object DataView]"?V(r,dt(e.buffer)):ct[r]?$e(e,r):V("CUSTOM",pt(e,t)))}function or(r,e){for(var t=r.length,n=new Array(t);--t>=0;)n[t]=ve(r[t],e);return n.join()}function ur(r){return Buffer.from(r).toString("utf8")}function cr(r){return String.fromCharCode.apply(null,new Uint16Array(r))}function lr(){return"UNSUPPORTED"}function fr(r){for(var e=r.children,t=e.length,n=new Array(t);--t>=0;)n[t]=e[t].outerHTML;return n.join()}var dt=typeof Buffer<"u"&&typeof Buffer.from=="function"?ur:typeof Uint16Array=="function"?cr:lr;function hr(r,e){var t=new Array(r.size),n=0;for(r.forEach(function(a,s){t[n++]=[ve(s,e),ve(a,e)]}),xe(t,nr);--n>=0;)t[n]="["+t[n][0]+","+t[n][1]+"]";return"["+t.join()+"]"}function pt(r,e){for(var t=xe(Object.getOwnPropertyNames(r),lt),n=t.length,a=new Array(n),s=n;--s>=0;)a[s]=t[s]+":"+ve(r[t[s]],e);return"{"+a.join()+"}"}function dr(r,e){var t=new Array(r.size),n=0;return r.forEach(function(a){t[n++]=ve(a,e)}),"["+xe(t,lt).join()+"]"}function ve(r,e){var t=typeof r;return r==null||t==="undefined"?Se.empty+r:t==="object"?sr(r,ir.call(r),e||{cache:new WeakMap,id:1}):t==="function"||t==="symbol"?Se[t]+r.toString():t==="boolean"?Se.boolean+ +r:Se[t]+r}function pr(r){return Yt(ve(r,void 0))}Be.default=pr,Object.defineProperty(we,"__esModule",{value:!0});var mr=function(){function r(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),gr=Be,vr=yr(gr);function yr(r){return r&&r.__esModule?r:{default:r}}function br(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var ze=function(){function r(e,t,n){br(this,r),this.id=e;var a={cache:!0};if(typeof n>"u"&&(n=a),typeof t!="function"?(this.value=t,this.type=this.constructor.CONSTANT):(this.calculationMethod=t,this.type=this.constructor.DYNAMIC),!this.id)throw new Error("factId required");return this.priority=parseInt(n.priority||1,10),this.options=Object.assign({},a,n),this.cacheKeyMethod=this.defaultCacheKeys,this}return mr(r,[{key:"isConstant",value:function(){return this.type===this.constructor.CONSTANT}},{key:"isDynamic",value:function(){return this.type===this.constructor.DYNAMIC}},{key:"calculate",value:function(t,n){return Object.prototype.hasOwnProperty.call(this,"value")?this.value:this.calculationMethod(t,n)}},{key:"defaultCacheKeys",value:function(t,n){return{params:n,id:t}}},{key:"getCacheKey",value:function(t){if(this.options.cache===!0){var n=this.cacheKeyMethod(this.id,t),a=r.hashFromObject(n);return a}}}],[{key:"hashFromObject",value:function(t){return(0,vr.default)(t)}}]),r}();ze.CONSTANT="CONSTANT",ze.DYNAMIC="DYNAMIC",we.default=ze;var Me={},Ne={},ye={};Object.defineProperty(ye,"__esModule",{value:!0}),ye.default=Ar;function Ar(r){try{(typeof process<"u"&&process.env&&process.env.DEBUG&&process.env.DEBUG.match(/json-rules-engine/)||typeof window<"u"&&window.localStorage&&window.localStorage.debug&&window.localStorage.debug.match(/json-rules-engine/))&&console.log(r)}catch{}}Object.defineProperty(Ne,"__esModule",{value:!0});var _r=function(){function r(e,t){var n=[],a=!0,s=!1,u=void 0;try{for(var h=e[Symbol.iterator](),p;!(a=(p=h.next()).done)&&(n.push(p.value),!(t&&n.length===t));a=!0);}catch(_){s=!0,u=_}finally{try{!a&&h.return&&h.return()}finally{if(s)throw u}}return n}return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return r(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),wr=function(){function r(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),Er=ye,Sr=Pr(Er);function Pr(r){return r&&r.__esModule?r:{default:r}}function Or(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var kr=function(){function r(e){if(Or(this,r),!e)throw new Error("Condition: constructor options required");var t=r.booleanOperator(e);if(Object.assign(this,e),t){var n=e[t],a=Array.isArray(n);if(t!=="not"&&!a)throw new Error('"'+t+'" must be an array');if(t==="not"&&a)throw new Error('"'+t+'" cannot be an array');this.operator=t,this.priority=parseInt(e.priority,10)||1,a?this[t]=n.map(function(s){return new r(s)}):this[t]=new r(n)}else if(!Object.prototype.hasOwnProperty.call(e,"condition")){if(!Object.prototype.hasOwnProperty.call(e,"fact"))throw new Error('Condition: constructor "fact" property required');if(!Object.prototype.hasOwnProperty.call(e,"operator"))throw new Error('Condition: constructor "operator" property required');if(!Object.prototype.hasOwnProperty.call(e,"value"))throw new Error('Condition: constructor "value" property required');Object.prototype.hasOwnProperty.call(e,"priority")&&(e.priority=parseInt(e.priority,10))}}return wr(r,[{key:"toJSON",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,n={};this.priority&&(n.priority=this.priority),this.name&&(n.name=this.name);var a=r.booleanOperator(this);return a?Array.isArray(this[a])?n[a]=this[a].map(function(s){return s.toJSON(!1)}):n[a]=this[a].toJSON(!1):this.isConditionReference()?n.condition=this.condition:(n.operator=this.operator,n.value=this.value,n.fact=this.fact,this.factResult!==void 0&&(n.factResult=this.factResult),this.result!==void 0&&(n.result=this.result),this.params&&(n.params=this.params),this.path&&(n.path=this.path)),t?JSON.stringify(n):n}},{key:"evaluate",value:function(t,n){var a=this;if(!t)return Promise.reject(new Error("almanac required"));if(!n)return Promise.reject(new Error("operatorMap required"));if(this.isBooleanOperator())return Promise.reject(new Error("Cannot evaluate() a boolean condition"));var s=n.get(this.operator);return s?Promise.all([t.getValue(this.value),t.factValue(this.fact,this.params,this.path)]).then(function(u){var h=_r(u,2),p=h[0],_=h[1],A=s.evaluate(_,p);return(0,Sr.default)("condition::evaluate <"+JSON.stringify(_)+" "+a.operator+" "+JSON.stringify(p)+"?> ("+A+")"),{result:A,leftHandSideValue:_,rightHandSideValue:p,operator:a.operator}}):Promise.reject(new Error("Unknown operator: "+this.operator))}},{key:"booleanOperator",value:function(){return r.booleanOperator(this)}},{key:"isBooleanOperator",value:function(){return r.booleanOperator(this)!==void 0}},{key:"isConditionReference",value:function(){return Object.prototype.hasOwnProperty.call(this,"condition")}}],[{key:"booleanOperator",value:function(t){if(Object.prototype.hasOwnProperty.call(t,"any"))return"any";if(Object.prototype.hasOwnProperty.call(t,"all"))return"all";if(Object.prototype.hasOwnProperty.call(t,"not"))return"not"}}]),r}();Ne.default=kr;var He={},mt={exports:{}};(function(r){var e=function(){function t(w,S){return S!=null&&w instanceof S}var n;try{n=Map}catch{n=function(){}}var a;try{a=Set}catch{a=function(){}}var s;try{s=Promise}catch{s=function(){}}function u(w,S,T,g,E){typeof S=="object"&&(T=S.depth,g=S.prototype,E=S.includeNonEnumerable,S=S.circular);var j=[],O=[],R=typeof Buffer<"u";typeof S>"u"&&(S=!0),typeof T>"u"&&(T=1/0);function G(C,$){if(C===null)return null;if($===0)return C;var M,K;if(typeof C!="object")return C;if(t(C,n))M=new n;else if(t(C,a))M=new a;else if(t(C,s))M=new s(function(ie,i){C.then(function(o){ie(G(o,$-1))},function(o){i(G(o,$-1))})});else if(u.__isArray(C))M=[];else if(u.__isRegExp(C))M=new RegExp(C.source,P(C)),C.lastIndex&&(M.lastIndex=C.lastIndex);else if(u.__isDate(C))M=new Date(C.getTime());else{if(R&&Buffer.isBuffer(C))return Buffer.allocUnsafe?M=Buffer.allocUnsafe(C.length):M=new Buffer(C.length),C.copy(M),M;t(C,Error)?M=Object.create(C):typeof g>"u"?(K=Object.getPrototypeOf(C),M=Object.create(K)):(M=Object.create(g),K=g)}if(S){var N=j.indexOf(C);if(N!=-1)return O[N];j.push(C),O.push(M)}t(C,n)&&C.forEach(function(ie,i){var o=G(i,$-1),c=G(ie,$-1);M.set(o,c)}),t(C,a)&&C.forEach(function(ie){var i=G(ie,$-1);M.add(i)});for(var z in C){var B;K&&(B=Object.getOwnPropertyDescriptor(K,z)),!(B&&B.set==null)&&(M[z]=G(C[z],$-1))}if(Object.getOwnPropertySymbols)for(var ue=Object.getOwnPropertySymbols(C),z=0;z<ue.length;z++){var ge=ue[z],ce=Object.getOwnPropertyDescriptor(C,ge);ce&&!ce.enumerable&&!E||(M[ge]=G(C[ge],$-1),ce.enumerable||Object.defineProperty(M,ge,{enumerable:!1}))}if(E)for(var I=Object.getOwnPropertyNames(C),z=0;z<I.length;z++){var Ae=I[z],ce=Object.getOwnPropertyDescriptor(C,Ae);ce&&ce.enumerable||(M[Ae]=G(C[Ae],$-1),Object.defineProperty(M,Ae,{enumerable:!1}))}return M}return G(w,T)}u.clonePrototype=function(S){if(S===null)return null;var T=function(){};return T.prototype=S,new T};function h(w){return Object.prototype.toString.call(w)}u.__objToStr=h;function p(w){return typeof w=="object"&&h(w)==="[object Date]"}u.__isDate=p;function _(w){return typeof w=="object"&&h(w)==="[object Array]"}u.__isArray=_;function A(w){return typeof w=="object"&&h(w)==="[object RegExp]"}u.__isRegExp=A;function P(w){var S="";return w.global&&(S+="g"),w.ignoreCase&&(S+="i"),w.multiline&&(S+="m"),S}return u.__getRegExpFlags=P,u}();r.exports&&(r.exports=e)})(mt);var gt=mt.exports;function Cr(r){return!!r&&typeof r=="object"}var vt=Cr;Object.defineProperty(He,"__esModule",{value:!0});var Tr=function(){function r(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),jr=gt,Le=yt(jr),Ir=vt,Fr=yt(Ir);function yt(r){return r&&r.__esModule?r:{default:r}}function Rr(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var Mr=function(){function r(e,t,n,a){Rr(this,r),this.conditions=(0,Le.default)(e),this.event=(0,Le.default)(t),this.priority=(0,Le.default)(n),this.name=(0,Le.default)(a),this.result=null}return Tr(r,[{key:"setResult",value:function(t){this.result=t}},{key:"resolveEventParams",value:function(t){var n=this;if((0,Fr.default)(this.event.params)){var a=[],s=function(p){Object.prototype.hasOwnProperty.call(n.event.params,p)&&a.push(t.getValue(n.event.params[p]).then(function(_){return n.event.params[p]=_}))};for(var u in this.event.params)s(u);return Promise.all(a)}return Promise.resolve()}},{key:"toJSON",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,n={conditions:this.conditions.toJSON(!1),event:this.event,priority:this.priority,name:this.name,result:this.result};return t?JSON.stringify(n):n}}]),r}();He.default=Mr;var bt={exports:{}};/*!
 * EventEmitter2
 * https://github.com/hij1nx/EventEmitter2
 *
 * Copyright (c) 2013 hij1nx
 * Licensed under the MIT license.
 */(function(r,e){(function(t){var n=Object.hasOwnProperty,a=Array.isArray?Array.isArray:function(o){return Object.prototype.toString.call(o)==="[object Array]"},s=10,u=typeof process=="object"&&typeof process.nextTick=="function",h=typeof Symbol=="function",p=typeof Reflect=="object",_=typeof setImmediate=="function",A=_?setImmediate:setTimeout,P=h?p&&typeof Reflect.ownKeys=="function"?Reflect.ownKeys:function(i){var o=Object.getOwnPropertyNames(i);return o.push.apply(o,Object.getOwnPropertySymbols(i)),o}:Object.keys;function w(){this._events={},this._conf&&S.call(this,this._conf)}function S(i){i&&(this._conf=i,i.delimiter&&(this.delimiter=i.delimiter),i.maxListeners!==t&&(this._maxListeners=i.maxListeners),i.wildcard&&(this.wildcard=i.wildcard),i.newListener&&(this._newListener=i.newListener),i.removeListener&&(this._removeListener=i.removeListener),i.verboseMemoryLeak&&(this.verboseMemoryLeak=i.verboseMemoryLeak),i.ignoreErrors&&(this.ignoreErrors=i.ignoreErrors),this.wildcard&&(this.listenerTree={}))}function T(i,o){var c="(node) warning: possible EventEmitter memory leak detected. "+i+" listeners added. Use emitter.setMaxListeners() to increase limit.";if(this.verboseMemoryLeak&&(c+=" Event name: "+o+"."),typeof process<"u"&&process.emitWarning){var l=new Error(c);l.name="MaxListenersExceededWarning",l.emitter=this,l.count=i,process.emitWarning(l)}else console.error(c),console.trace&&console.trace()}var g=function(i,o,c){var l=arguments.length;switch(l){case 0:return[];case 1:return[i];case 2:return[i,o];case 3:return[i,o,c];default:for(var f=new Array(l);l--;)f[l]=arguments[l];return f}};function E(i,o){for(var c={},l,f=i.length,d=o?o.length:0,m=0;m<f;m++)l=i[m],c[l]=m<d?o[m]:t;return c}function j(i,o,c){this._emitter=i,this._target=o,this._listeners={},this._listenersCount=0;var l,f;if((c.on||c.off)&&(l=c.on,f=c.off),o.addEventListener?(l=o.addEventListener,f=o.removeEventListener):o.addListener?(l=o.addListener,f=o.removeListener):o.on&&(l=o.on,f=o.off),!l&&!f)throw Error("target does not implement any known event API");if(typeof l!="function")throw TypeError("on method must be a function");if(typeof f!="function")throw TypeError("off method must be a function");this._on=l,this._off=f;var d=i._observers;d?d.push(this):i._observers=[this]}Object.assign(j.prototype,{subscribe:function(i,o,c){var l=this,f=this._target,d=this._emitter,m=this._listeners,b=function(){var v=g.apply(null,arguments),y={data:v,name:o,original:i};if(c){var k=c.call(f,y);k!==!1&&d.emit.apply(d,[y.name].concat(v));return}d.emit.apply(d,[o].concat(v))};if(m[i])throw Error("Event '"+i+"' is already listening");this._listenersCount++,d._newListener&&d._removeListener&&!l._onNewListener?(this._onNewListener=function(v){v===o&&m[i]===null&&(m[i]=b,l._on.call(f,i,b))},d.on("newListener",this._onNewListener),this._onRemoveListener=function(v){v===o&&!d.hasListeners(v)&&m[i]&&(m[i]=null,l._off.call(f,i,b))},m[i]=null,d.on("removeListener",this._onRemoveListener)):(m[i]=b,l._on.call(f,i,b))},unsubscribe:function(i){var o=this,c=this._listeners,l=this._emitter,f,d,m=this._off,b=this._target,v;if(i&&typeof i!="string")throw TypeError("event must be a string");function y(){o._onNewListener&&(l.off("newListener",o._onNewListener),l.off("removeListener",o._onRemoveListener),o._onNewListener=null,o._onRemoveListener=null);var k=K.call(l,o);l._observers.splice(k,1)}if(i){if(f=c[i],!f)return;m.call(b,i,f),delete c[i],--this._listenersCount||y()}else{for(d=P(c),v=d.length;v-- >0;)i=d[v],m.call(b,i,c[i]);this._listeners={},this._listenersCount=0,y()}}});function O(i,o,c,l){var f=Object.assign({},o);if(!i)return f;if(typeof i!="object")throw TypeError("options must be an object");var d=Object.keys(i),m=d.length,b,v,y;function k(L){throw Error('Invalid "'+b+'" option value'+(L?". Reason: "+L:""))}for(var q=0;q<m;q++){if(b=d[q],!l&&!n.call(o,b))throw Error('Unknown "'+b+'" option');v=i[b],v!==t&&(y=c[b],f[b]=y?y(v,k):v)}return f}function R(i,o){return(typeof i!="function"||!i.hasOwnProperty("prototype"))&&o("value must be a constructor"),i}function G(i){var o="value must be type of "+i.join("|"),c=i.length,l=i[0],f=i[1];return c===1?function(d,m){if(typeof d===l)return d;m(o)}:c===2?function(d,m){var b=typeof d;if(b===l||b===f)return d;m(o)}:function(d,m){for(var b=typeof d,v=c;v-- >0;)if(b===i[v])return d;m(o)}}var C=G(["function"]),$=G(["object","function"]);function M(i,o,c){var l,f,d=0,m,b=new i(function(v,y,k){c=O(c,{timeout:0,overload:!1},{timeout:function(x,J){return x*=1,(typeof x!="number"||x<0||!Number.isFinite(x))&&J("timeout must be a positive number"),x}}),l=!c.overload&&typeof i.prototype.cancel=="function"&&typeof k=="function";function q(){f&&(f=null),d&&(clearTimeout(d),d=0)}var L=function(x){q(),v(x)},D=function(x){q(),y(x)};l?o(L,D,k):(f=[function(x){D(x||Error("canceled"))}],o(L,D,function(x){if(m)throw Error("Unable to subscribe on cancel event asynchronously");if(typeof x!="function")throw TypeError("onCancel callback must be a function");f.push(x)}),m=!0),c.timeout>0&&(d=setTimeout(function(){var x=Error("timeout");x.code="ETIMEDOUT",d=0,b.cancel(x),y(x)},c.timeout))});return l||(b.cancel=function(v){if(f){for(var y=f.length,k=1;k<y;k++)f[k](v);f[0](v),f=null}}),b}function K(i){var o=this._observers;if(!o)return-1;for(var c=o.length,l=0;l<c;l++)if(o[l]._target===i)return l;return-1}function N(i,o,c,l,f){if(!c)return null;if(l===0){var d=typeof o;if(d==="string"){var m,b,v=0,y=0,k=this.delimiter,q=k.length;if((b=o.indexOf(k))!==-1){m=new Array(5);do m[v++]=o.slice(y,b),y=b+q;while((b=o.indexOf(k,y))!==-1);m[v++]=o.slice(y),o=m,f=v}else o=[o],f=1}else d==="object"?f=o.length:(o=[o],f=1)}var L=null,D,x,J,et,tt,Fe=o[l],rt=o[l+1],se,Y;if(l===f)c._listeners&&(typeof c._listeners=="function"?(i&&i.push(c._listeners),L=[c]):(i&&i.push.apply(i,c._listeners),L=[c]));else if(Fe==="*"){for(se=P(c),b=se.length;b-- >0;)D=se[b],D!=="_listeners"&&(Y=N(i,o,c[D],l+1,f),Y&&(L?L.push.apply(L,Y):L=Y));return L}else if(Fe==="**"){for(tt=l+1===f||l+2===f&&rt==="*",tt&&c._listeners&&(L=N(i,o,c,f,f)),se=P(c),b=se.length;b-- >0;)D=se[b],D!=="_listeners"&&(D==="*"||D==="**"?(c[D]._listeners&&!tt&&(Y=N(i,o,c[D],f,f),Y&&(L?L.push.apply(L,Y):L=Y)),Y=N(i,o,c[D],l,f)):D===rt?Y=N(i,o,c[D],l+2,f):Y=N(i,o,c[D],l,f),Y&&(L?L.push.apply(L,Y):L=Y));return L}else c[Fe]&&(L=N(i,o,c[Fe],l+1,f));if(x=c["*"],x&&N(i,o,x,l+1,f),J=c["**"],J)if(l<f)for(J._listeners&&N(i,o,J,f,f),se=P(J),b=se.length;b-- >0;)D=se[b],D!=="_listeners"&&(D===rt?N(i,o,J[D],l+2,f):D===Fe?N(i,o,J[D],l+1,f):(et={},et[D]=J[D],N(i,o,{"**":et},l+1,f)));else J._listeners?N(i,o,J,f,f):J["*"]&&J["*"]._listeners&&N(i,o,J["*"],f,f);return L}function z(i,o,c){var l=0,f=0,d,m=this.delimiter,b=m.length,v;if(typeof i=="string")if((d=i.indexOf(m))!==-1){v=new Array(5);do v[l++]=i.slice(f,d),f=d+b;while((d=i.indexOf(m,f))!==-1);v[l++]=i.slice(f)}else v=[i],l=1;else v=i,l=i.length;if(l>1){for(d=0;d+1<l;d++)if(v[d]==="**"&&v[d+1]==="**")return}var y=this.listenerTree,k;for(d=0;d<l;d++)if(k=v[d],y=y[k]||(y[k]={}),d===l-1)return y._listeners?(typeof y._listeners=="function"&&(y._listeners=[y._listeners]),c?y._listeners.unshift(o):y._listeners.push(o),!y._listeners.warned&&this._maxListeners>0&&y._listeners.length>this._maxListeners&&(y._listeners.warned=!0,T.call(this,y._listeners.length,k))):y._listeners=o,!0;return!0}function B(i,o,c,l){for(var f=P(i),d=f.length,m,b,v,y=i._listeners,k;d-- >0;)b=f[d],m=i[b],b==="_listeners"?v=c:v=c?c.concat(b):[b],k=l||typeof b=="symbol",y&&o.push(k?v:v.join(this.delimiter)),typeof m=="object"&&B.call(this,m,o,v,k);return o}function ue(i){for(var o=P(i),c=o.length,l,f,d;c-- >0;)f=o[c],l=i[f],l&&(d=!0,f!=="_listeners"&&!ue(l)&&delete i[f]);return d}function ge(i,o,c){this.emitter=i,this.event=o,this.listener=c}ge.prototype.off=function(){return this.emitter.off(this.event,this.listener),this};function ce(i,o,c){if(c===!0)f=!0;else if(c===!1)l=!0;else{if(!c||typeof c!="object")throw TypeError("options should be an object or true");var l=c.async,f=c.promisify,d=c.nextTick,m=c.objectify}if(l||d||f){var b=o,v=o._origin||o;if(d&&!u)throw Error("process.nextTick is not supported");f===t&&(f=o.constructor.name==="AsyncFunction"),o=function(){var y=arguments,k=this,q=this.event;return f?d?Promise.resolve():new Promise(function(L){A(L)}).then(function(){return k.event=q,b.apply(k,y)}):(d?process.nextTick:A)(function(){k.event=q,b.apply(k,y)})},o._async=!0,o._origin=v}return[o,m?new ge(this,i,o):this]}function I(i){this._events={},this._newListener=!1,this._removeListener=!1,this.verboseMemoryLeak=!1,S.call(this,i)}I.EventEmitter2=I,I.prototype.listenTo=function(i,o,c){if(typeof i!="object")throw TypeError("target musts be an object");var l=this;c=O(c,{on:t,off:t,reducers:t},{on:C,off:C,reducers:$});function f(d){if(typeof d!="object")throw TypeError("events must be an object");var m=c.reducers,b=K.call(l,i),v;b===-1?v=new j(l,i,c):v=l._observers[b];for(var y=P(d),k=y.length,q,L=typeof m=="function",D=0;D<k;D++)q=y[D],v.subscribe(q,d[q]||q,L?m:m&&m[q])}return a(o)?f(E(o)):f(typeof o=="string"?E(o.split(/\s+/)):o),this},I.prototype.stopListeningTo=function(i,o){var c=this._observers;if(!c)return!1;var l=c.length,f,d=!1;if(i&&typeof i!="object")throw TypeError("target should be an object");for(;l-- >0;)f=c[l],(!i||f._target===i)&&(f.unsubscribe(o),d=!0);return d},I.prototype.delimiter=".",I.prototype.setMaxListeners=function(i){i!==t&&(this._maxListeners=i,this._conf||(this._conf={}),this._conf.maxListeners=i)},I.prototype.getMaxListeners=function(){return this._maxListeners},I.prototype.event="",I.prototype.once=function(i,o,c){return this._once(i,o,!1,c)},I.prototype.prependOnceListener=function(i,o,c){return this._once(i,o,!0,c)},I.prototype._once=function(i,o,c,l){return this._many(i,1,o,c,l)},I.prototype.many=function(i,o,c,l){return this._many(i,o,c,!1,l)},I.prototype.prependMany=function(i,o,c,l){return this._many(i,o,c,!0,l)},I.prototype._many=function(i,o,c,l,f){var d=this;if(typeof c!="function")throw new Error("many only accepts instances of Function");function m(){return--o===0&&d.off(i,m),c.apply(this,arguments)}return m._origin=c,this._on(i,m,l,f)},I.prototype.emit=function(){if(!this._events&&!this._all)return!1;this._events||w.call(this);var i=arguments[0],o,c=this.wildcard,l,f,d,m,b;if(i==="newListener"&&!this._newListener&&!this._events.newListener)return!1;if(c&&(o=i,i!=="newListener"&&i!=="removeListener"&&typeof i=="object")){if(f=i.length,h){for(d=0;d<f;d++)if(typeof i[d]=="symbol"){b=!0;break}}b||(i=i.join(this.delimiter))}var v=arguments.length,y;if(this._all&&this._all.length)for(y=this._all.slice(),d=0,f=y.length;d<f;d++)switch(this.event=i,v){case 1:y[d].call(this,i);break;case 2:y[d].call(this,i,arguments[1]);break;case 3:y[d].call(this,i,arguments[1],arguments[2]);break;default:y[d].apply(this,arguments)}if(c)y=[],N.call(this,y,o,this.listenerTree,0,f);else if(y=this._events[i],typeof y=="function"){switch(this.event=i,v){case 1:y.call(this);break;case 2:y.call(this,arguments[1]);break;case 3:y.call(this,arguments[1],arguments[2]);break;default:for(l=new Array(v-1),m=1;m<v;m++)l[m-1]=arguments[m];y.apply(this,l)}return!0}else y&&(y=y.slice());if(y&&y.length){if(v>3)for(l=new Array(v-1),m=1;m<v;m++)l[m-1]=arguments[m];for(d=0,f=y.length;d<f;d++)switch(this.event=i,v){case 1:y[d].call(this);break;case 2:y[d].call(this,arguments[1]);break;case 3:y[d].call(this,arguments[1],arguments[2]);break;default:y[d].apply(this,l)}return!0}else if(!this.ignoreErrors&&!this._all&&i==="error")throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");return!!this._all},I.prototype.emitAsync=function(){if(!this._events&&!this._all)return!1;this._events||w.call(this);var i=arguments[0],o=this.wildcard,c,l,f,d,m,b;if(i==="newListener"&&!this._newListener&&!this._events.newListener)return Promise.resolve([!1]);if(o&&(c=i,i!=="newListener"&&i!=="removeListener"&&typeof i=="object")){if(d=i.length,h){for(m=0;m<d;m++)if(typeof i[m]=="symbol"){l=!0;break}}l||(i=i.join(this.delimiter))}var v=[],y=arguments.length,k;if(this._all)for(m=0,d=this._all.length;m<d;m++)switch(this.event=i,y){case 1:v.push(this._all[m].call(this,i));break;case 2:v.push(this._all[m].call(this,i,arguments[1]));break;case 3:v.push(this._all[m].call(this,i,arguments[1],arguments[2]));break;default:v.push(this._all[m].apply(this,arguments))}if(o?(k=[],N.call(this,k,c,this.listenerTree,0)):k=this._events[i],typeof k=="function")switch(this.event=i,y){case 1:v.push(k.call(this));break;case 2:v.push(k.call(this,arguments[1]));break;case 3:v.push(k.call(this,arguments[1],arguments[2]));break;default:for(f=new Array(y-1),b=1;b<y;b++)f[b-1]=arguments[b];v.push(k.apply(this,f))}else if(k&&k.length){if(k=k.slice(),y>3)for(f=new Array(y-1),b=1;b<y;b++)f[b-1]=arguments[b];for(m=0,d=k.length;m<d;m++)switch(this.event=i,y){case 1:v.push(k[m].call(this));break;case 2:v.push(k[m].call(this,arguments[1]));break;case 3:v.push(k[m].call(this,arguments[1],arguments[2]));break;default:v.push(k[m].apply(this,f))}}else if(!this.ignoreErrors&&!this._all&&i==="error")return arguments[1]instanceof Error?Promise.reject(arguments[1]):Promise.reject("Uncaught, unspecified 'error' event.");return Promise.all(v)},I.prototype.on=function(i,o,c){return this._on(i,o,!1,c)},I.prototype.prependListener=function(i,o,c){return this._on(i,o,!0,c)},I.prototype.onAny=function(i){return this._onAny(i,!1)},I.prototype.prependAny=function(i){return this._onAny(i,!0)},I.prototype.addListener=I.prototype.on,I.prototype._onAny=function(i,o){if(typeof i!="function")throw new Error("onAny only accepts instances of Function");return this._all||(this._all=[]),o?this._all.unshift(i):this._all.push(i),this},I.prototype._on=function(i,o,c,l){if(typeof i=="function")return this._onAny(i,o),this;if(typeof o!="function")throw new Error("on only accepts instances of Function");this._events||w.call(this);var f=this,d;return l!==t&&(d=ce.call(this,i,o,l),o=d[0],f=d[1]),this._newListener&&this.emit("newListener",i,o),this.wildcard?(z.call(this,i,o,c),f):(this._events[i]?(typeof this._events[i]=="function"&&(this._events[i]=[this._events[i]]),c?this._events[i].unshift(o):this._events[i].push(o),!this._events[i].warned&&this._maxListeners>0&&this._events[i].length>this._maxListeners&&(this._events[i].warned=!0,T.call(this,this._events[i].length,i))):this._events[i]=o,f)},I.prototype.off=function(i,o){if(typeof o!="function")throw new Error("removeListener only takes instances of Function");var c,l=[];if(this.wildcard){var f=typeof i=="string"?i.split(this.delimiter):i.slice();if(l=N.call(this,null,f,this.listenerTree,0),!l)return this}else{if(!this._events[i])return this;c=this._events[i],l.push({_listeners:c})}for(var d=0;d<l.length;d++){var m=l[d];if(c=m._listeners,a(c)){for(var b=-1,v=0,y=c.length;v<y;v++)if(c[v]===o||c[v].listener&&c[v].listener===o||c[v]._origin&&c[v]._origin===o){b=v;break}if(b<0)continue;return this.wildcard?m._listeners.splice(b,1):this._events[i].splice(b,1),c.length===0&&(this.wildcard?delete m._listeners:delete this._events[i]),this._removeListener&&this.emit("removeListener",i,o),this}else(c===o||c.listener&&c.listener===o||c._origin&&c._origin===o)&&(this.wildcard?delete m._listeners:delete this._events[i],this._removeListener&&this.emit("removeListener",i,o))}return this.listenerTree&&ue(this.listenerTree),this},I.prototype.offAny=function(i){var o=0,c=0,l;if(i&&this._all&&this._all.length>0){for(l=this._all,o=0,c=l.length;o<c;o++)if(i===l[o])return l.splice(o,1),this._removeListener&&this.emit("removeListenerAny",i),this}else{if(l=this._all,this._removeListener)for(o=0,c=l.length;o<c;o++)this.emit("removeListenerAny",l[o]);this._all=[]}return this},I.prototype.removeListener=I.prototype.off,I.prototype.removeAllListeners=function(i){if(i===t)return!this._events||w.call(this),this;if(this.wildcard){var o=N.call(this,null,i,this.listenerTree,0),c,l;if(!o)return this;for(l=0;l<o.length;l++)c=o[l],c._listeners=null;this.listenerTree&&ue(this.listenerTree)}else this._events&&(this._events[i]=null);return this},I.prototype.listeners=function(i){var o=this._events,c,l,f,d,m;if(i===t){if(this.wildcard)throw Error("event name required for wildcard emitter");if(!o)return[];for(c=P(o),d=c.length,f=[];d-- >0;)l=o[c[d]],typeof l=="function"?f.push(l):f.push.apply(f,l);return f}else{if(this.wildcard){if(m=this.listenerTree,!m)return[];var b=[],v=typeof i=="string"?i.split(this.delimiter):i.slice();return N.call(this,b,v,m,0),b}return o?(l=o[i],l?typeof l=="function"?[l]:l:[]):[]}},I.prototype.eventNames=function(i){var o=this._events;return this.wildcard?B.call(this,this.listenerTree,[],null,i):o?P(o):[]},I.prototype.listenerCount=function(i){return this.listeners(i).length},I.prototype.hasListeners=function(i){if(this.wildcard){var o=[],c=typeof i=="string"?i.split(this.delimiter):i.slice();return N.call(this,o,c,this.listenerTree,0),o.length>0}var l=this._events,f=this._all;return!!(f&&f.length||l&&(i===t?P(l).length:l[i]))},I.prototype.listenersAny=function(){return this._all?this._all:[]},I.prototype.waitFor=function(i,o){var c=this,l=typeof o;return l==="number"?o={timeout:o}:l==="function"&&(o={filter:o}),o=O(o,{timeout:0,filter:t,handleError:!1,Promise,overload:!1},{filter:C,Promise:R}),M(o.Promise,function(f,d,m){function b(){var v=o.filter;if(!(v&&!v.apply(c,arguments)))if(c.off(i,b),o.handleError){var y=arguments[0];y?d(y):f(g.apply(null,arguments).slice(1))}else f(g.apply(null,arguments))}m(function(){c.off(i,b)}),c._on(i,b,!1)},{timeout:o.timeout,overload:o.overload})};function Ae(i,o,c){c=O(c,{Promise,timeout:0,overload:!1},{Promise:R});var l=c.Promise;return M(l,function(f,d,m){var b;if(typeof i.addEventListener=="function"){b=function(){f(g.apply(null,arguments))},m(function(){i.removeEventListener(o,b)}),i.addEventListener(o,b,{once:!0});return}var v=function(){y&&i.removeListener("error",y),f(g.apply(null,arguments))},y;o!=="error"&&(y=function(k){i.removeListener(o,v),d(k)},i.once("error",y)),m(function(){y&&i.removeListener("error",y),i.removeListener(o,v)}),i.once(o,v)},{timeout:c.timeout,overload:c.overload})}var ie=I.prototype;Object.defineProperties(I,{defaultMaxListeners:{get:function(){return ie._maxListeners},set:function(i){if(typeof i!="number"||i<0||Number.isNaN(i))throw TypeError("n must be a non-negative number");ie._maxListeners=i},enumerable:!0},once:{value:Ae,writable:!0,configurable:!0}}),Object.defineProperties(ie,{_maxListeners:{value:s,writable:!0,configurable:!0},_observers:{value:null,writable:!0,configurable:!0}}),typeof t=="function"&&t.amd?t(function(){return I}):r.exports=I})()})(bt);var At=bt.exports;Object.defineProperty(Me,"__esModule",{value:!0});var Nr=function(){function r(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),Lr=Ne,Dr=Pe(Lr),Ur=He,Br=Pe(Ur),xr=ye,Ve=Pe(xr),$r=gt,zr=Pe($r),Hr=At,Vr=Pe(Hr);function Pe(r){return r&&r.__esModule?r:{default:r}}function Gr(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function qr(r,e){if(!r)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:r}function Kr(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(r,e):r.__proto__=e)}var Jr=function(r){Kr(e,r);function e(t){Gr(this,e);var n=qr(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));typeof t=="string"&&(t=JSON.parse(t)),t&&t.conditions&&n.setConditions(t.conditions),t&&t.onSuccess&&n.on("success",t.onSuccess),t&&t.onFailure&&n.on("failure",t.onFailure),t&&(t.name||t.name===0)&&n.setName(t.name);var a=t&&t.priority||1;n.setPriority(a);var s=t&&t.event||{type:"unknown"};return n.setEvent(s),n}return Nr(e,[{key:"setPriority",value:function(n){if(n=parseInt(n,10),n<=0)throw new Error("Priority must be greater than zero");return this.priority=n,this}},{key:"setName",value:function(n){if(!n&&n!==0)throw new Error('Rule "name" must be defined');return this.name=n,this}},{key:"setConditions",value:function(n){if(!Object.prototype.hasOwnProperty.call(n,"all")&&!Object.prototype.hasOwnProperty.call(n,"any")&&!Object.prototype.hasOwnProperty.call(n,"not")&&!Object.prototype.hasOwnProperty.call(n,"condition"))throw new Error('"conditions" root must contain a single instance of "all", "any", "not", or "condition"');return this.conditions=new Dr.default(n),this}},{key:"setEvent",value:function(n){if(!n)throw new Error("Rule: setEvent() requires event object");if(!Object.prototype.hasOwnProperty.call(n,"type"))throw new Error('Rule: setEvent() requires event object with "type" property');return this.ruleEvent={type:n.type},n.params&&(this.ruleEvent.params=n.params),this}},{key:"getEvent",value:function(){return this.ruleEvent}},{key:"getPriority",value:function(){return this.priority}},{key:"getConditions",value:function(){return this.conditions}},{key:"getEngine",value:function(){return this.engine}},{key:"setEngine",value:function(n){return this.engine=n,this}},{key:"toJSON",value:function(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,a={conditions:this.conditions.toJSON(!1),priority:this.priority,event:this.ruleEvent,name:this.name};return n?JSON.stringify(a):a}},{key:"prioritizeConditions",value:function(n){var a=this,s=n.reduce(function(u,h){var p=h.priority;if(!p){var _=a.engine.getFact(h.fact);p=_&&_.priority||1}return u[p]||(u[p]=[]),u[p].push(h),u},{});return Object.keys(s).sort(function(u,h){return Number(u)>Number(h)?-1:1}).map(function(u){return s[u]})}},{key:"evaluate",value:function(n){var a=this,s=new Br.default(this.conditions,this.ruleEvent,this.priority,this.name),u=function(g){if(g.isConditionReference())return w(g);if(g.isBooleanOperator()){var E=g[g.operator],j=void 0;return g.operator==="all"?j=A(E):g.operator==="any"?j=_(E):j=P(E),j.then(function(O){var R=O===!0;return g.result=R,R})}else return g.evaluate(n,a.engine.operators).then(function(O){var R=O.result;return g.factResult=O.leftHandSideValue,g.result=R,R})},h=function(g,E){return Array.isArray(g)||(g=[g]),Promise.all(g.map(function(j){return u(j)})).then(function(j){return(0,Ve.default)("rule::evaluateConditions results",j),E.call(j,function(O){return O===!0})})},p=function(g,E){if(g.length===0)return Promise.resolve(!0);if(g.length===1)return u(g[0]);var j=Array.prototype.some;E==="all"&&(j=Array.prototype.every);for(var O=a.prioritizeConditions(g),R=Promise.resolve(),G=function(M){var K=O[M],N=!1;R=R.then(function(z){return E==="any"&&z===!0||N?((0,Ve.default)("prioritizeAndRun::detected truthy result; skipping remaining conditions"),N=!0,!0):E==="all"&&z===!1||N?((0,Ve.default)("prioritizeAndRun::detected falsey result; skipping remaining conditions"),N=!0,!1):h(K,j)})},C=0;C<O.length;C++)G(C);return R},_=function(g){return p(g,"any")},A=function(g){return p(g,"all")},P=function(g){return p([g],"not").then(function(E){return!E})},w=function(g){var E=a.engine.conditions.get(g.condition);if(E)return delete g.condition,Object.assign(g,(0,zr.default)(E)),u(g);if(a.engine.allowUndefinedConditions)return g.result=!1,Promise.resolve(!1);throw new Error("No condition "+g.condition+" exists")},S=function(g){s.setResult(g);var E=Promise.resolve();a.engine.replaceFactsInEventParams&&(E=s.resolveEventParams(n));var j=g?"success":"failure";return E.then(function(){return a.emitAsync(j,s.event,n,s)}).then(function(){return s})};return s.conditions.any?_(s.conditions.any).then(function(T){return S(T)}):s.conditions.all?A(s.conditions.all).then(function(T){return S(T)}):s.conditions.not?P(s.conditions.not).then(function(T){return S(T)}):w(s.conditions).then(function(T){return S(T)})}}]),e}(Vr.default);Me.default=Jr;var Oe={};Object.defineProperty(Oe,"__esModule",{value:!0});var Wr=function(){function r(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function Yr(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var Zr=function(){function r(e,t,n){if(Yr(this,r),this.name=String(e),!e)throw new Error("Missing operator name");if(typeof t!="function")throw new Error("Missing operator callback");this.cb=t,this.factValueValidator=n,this.factValueValidator||(this.factValueValidator=function(){return!0})}return Wr(r,[{key:"evaluate",value:function(t,n){return this.factValueValidator(t)&&this.cb(t,n)}}]),r}();Oe.default=Zr;var De={},Ge={};Object.defineProperty(Ge,"__esModule",{value:!0});function Qr(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Xr(r,e){if(!r)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:r}function en(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(r,e):r.__proto__=e)}Ge.UndefinedFactError=function(r){en(e,r);function e(){var t;Qr(this,e);for(var n=arguments.length,a=Array(n),s=0;s<n;s++)a[s]=arguments[s];var u=Xr(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(a)));return u.code="UNDEFINED_FACT",u}return e}(Error);function te(r){"@babel/helpers - typeof";return te=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},te(r)}function _t(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function wt(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function Et(r,e,t){return e&&wt(r.prototype,e),t&&wt(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function tn(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Ce(r,e)}function ke(r){return ke=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},ke(r)}function Ce(r,e){return Ce=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,a){return n.__proto__=a,n},Ce(r,e)}function St(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Te(r,e,t){return St()?Te=Reflect.construct.bind():Te=function(a,s,u){var h=[null];h.push.apply(h,s);var p=Function.bind.apply(a,h),_=new p;return u&&Ce(_,u.prototype),_},Te.apply(null,arguments)}function rn(r){return Function.toString.call(r).indexOf("[native code]")!==-1}function qe(r){var e=typeof Map=="function"?new Map:void 0;return qe=function(n){if(n===null||!rn(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(typeof e<"u"){if(e.has(n))return e.get(n);e.set(n,a)}function a(){return Te(n,arguments,ke(this).constructor)}return a.prototype=Object.create(n.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),Ce(a,n)},qe(r)}function nn(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function an(r,e){if(e&&(typeof e=="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return nn(r)}function sn(r){var e=St();return function(){var n=ke(r),a;if(e){var s=ke(this).constructor;a=Reflect.construct(n,arguments,s)}else a=n.apply(this,arguments);return an(this,a)}}function on(r){return un(r)||cn(r)||Pt(r)||ln()}function un(r){if(Array.isArray(r))return Ke(r)}function cn(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}function Pt(r,e){if(r){if(typeof r=="string")return Ke(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Ke(r,e)}}function Ke(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}function ln(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function fn(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=Pt(r))||e&&r&&typeof r.length=="number"){t&&(r=t);var n=0,a=function(){};return{s:a,n:function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},e:function(p){throw p},f:a}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var s=!0,u=!1,h;return{s:function(){t=t.call(r)},n:function(){var p=t.next();return s=p.done,p},e:function(p){u=!0,h=p},f:function(){try{!s&&t.return!=null&&t.return()}finally{if(u)throw h}}}}var W=Object.prototype.hasOwnProperty;function fe(r,e){return r=r.slice(),r.push(e),r}function Je(r,e){return e=e.slice(),e.unshift(r),e}var hn=function(r){tn(t,r);var e=sn(t);function t(n){var a;return _t(this,t),a=e.call(this,'JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)'),a.avoidNew=!0,a.value=n,a.name="NewError",a}return Et(t)}(qe(Error));function U(r,e,t,n,a){if(!(this instanceof U))try{return new U(r,e,t,n,a)}catch(p){if(!p.avoidNew)throw p;return p.value}typeof r=="string"&&(a=n,n=t,t=e,e=r,r=null);var s=r&&te(r)==="object";if(r=r||{},this.json=r.json||t,this.path=r.path||e,this.resultType=r.resultType||"value",this.flatten=r.flatten||!1,this.wrap=W.call(r,"wrap")?r.wrap:!0,this.sandbox=r.sandbox||{},this.preventEval=r.preventEval||!1,this.parent=r.parent||null,this.parentProperty=r.parentProperty||null,this.callback=r.callback||n||null,this.otherTypeCallback=r.otherTypeCallback||a||function(){throw new TypeError("You must supply an otherTypeCallback callback option with the @other() operator.")},r.autostart!==!1){var u={path:s?r.path:e};s?"json"in r&&(u.json=r.json):u.json=t;var h=this.evaluate(u);if(!h||te(h)!=="object")throw new hn(h);return h}}U.prototype.evaluate=function(r,e,t,n){var a=this,s=this.parent,u=this.parentProperty,h=this.flatten,p=this.wrap;if(this.currResultType=this.resultType,this.currPreventEval=this.preventEval,this.currSandbox=this.sandbox,t=t||this.callback,this.currOtherTypeCallback=n||this.otherTypeCallback,e=e||this.json,r=r||this.path,r&&te(r)==="object"&&!Array.isArray(r)){if(!r.path&&r.path!=="")throw new TypeError('You must supply a "path" property when providing an object argument to JSONPath.evaluate().');if(!W.call(r,"json"))throw new TypeError('You must supply a "json" property when providing an object argument to JSONPath.evaluate().');var _=r;e=_.json,h=W.call(r,"flatten")?r.flatten:h,this.currResultType=W.call(r,"resultType")?r.resultType:this.currResultType,this.currSandbox=W.call(r,"sandbox")?r.sandbox:this.currSandbox,p=W.call(r,"wrap")?r.wrap:p,this.currPreventEval=W.call(r,"preventEval")?r.preventEval:this.currPreventEval,t=W.call(r,"callback")?r.callback:t,this.currOtherTypeCallback=W.call(r,"otherTypeCallback")?r.otherTypeCallback:this.currOtherTypeCallback,s=W.call(r,"parent")?r.parent:s,u=W.call(r,"parentProperty")?r.parentProperty:u,r=r.path}if(s=s||null,u=u||null,Array.isArray(r)&&(r=U.toPathString(r)),!(!r&&r!==""||!e)){var A=U.toPathArray(r);A[0]==="$"&&A.length>1&&A.shift(),this._hasParentSelector=null;var P=this._trace(A,e,["$"],s,u,t).filter(function(w){return w&&!w.isParentSelector});return P.length?!p&&P.length===1&&!P[0].hasArrExpr?this._getPreferredOutput(P[0]):P.reduce(function(w,S){var T=a._getPreferredOutput(S);return h&&Array.isArray(T)?w=w.concat(T):w.push(T),w},[]):p?[]:void 0}},U.prototype._getPreferredOutput=function(r){var e=this.currResultType;switch(e){case"all":{var t=Array.isArray(r.path)?r.path:U.toPathArray(r.path);return r.pointer=U.toPointer(t),r.path=typeof r.path=="string"?r.path:U.toPathString(r.path),r}case"value":case"parent":case"parentProperty":return r[e];case"path":return U.toPathString(r[e]);case"pointer":return U.toPointer(r.path);default:throw new TypeError("Unknown result type")}},U.prototype._handleCallback=function(r,e,t){if(e){var n=this._getPreferredOutput(r);r.path=typeof r.path=="string"?r.path:U.toPathString(r.path),e(n,t,r)}},U.prototype._trace=function(r,e,t,n,a,s,u,h){var p=this,_;if(!r.length)return _={path:t,value:e,parent:n,parentProperty:a,hasArrExpr:u},this._handleCallback(_,s,"value"),_;var A=r[0],P=r.slice(1),w=[];function S(B){Array.isArray(B)?B.forEach(function(ue){w.push(ue)}):w.push(B)}if((typeof A!="string"||h)&&e&&W.call(e,A))S(this._trace(P,e[A],fe(t,A),e,A,s,u));else if(A==="*")this._walk(e,function(B){S(p._trace(P,e[B],fe(t,B),e,B,s,!0,!0))});else if(A==="..")S(this._trace(P,e,t,n,a,s,u)),this._walk(e,function(B){te(e[B])==="object"&&S(p._trace(r.slice(),e[B],fe(t,B),e,B,s,!0))});else{if(A==="^")return this._hasParentSelector=!0,{path:t.slice(0,-1),expr:P,isParentSelector:!0};if(A==="~")return _={path:fe(t,A),value:a,parent:n,parentProperty:null},this._handleCallback(_,s,"property"),_;if(A==="$")S(this._trace(P,e,t,null,null,s,u));else if(/^(\x2D?[0-9]*):(\x2D?[0-9]*):?([0-9]*)$/.test(A))S(this._slice(A,P,e,t,n,a,s));else if(A.indexOf("?(")===0){if(this.currPreventEval)throw new Error("Eval [?(expr)] prevented in JSONPath expression.");var T=A.replace(/^\?\(((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?)\)$/,"$1");this._walk(e,function(B){p._eval(T,e[B],B,t,n,a)&&S(p._trace(P,e[B],fe(t,B),e,B,s,!0))})}else if(A[0]==="("){if(this.currPreventEval)throw new Error("Eval [(expr)] prevented in JSONPath expression.");S(this._trace(Je(this._eval(A,e,t[t.length-1],t.slice(0,-1),n,a),P),e,t,n,a,s,u))}else if(A[0]==="@"){var g=!1,E=A.slice(1,-2);switch(E){case"scalar":(!e||!["object","function"].includes(te(e)))&&(g=!0);break;case"boolean":case"string":case"undefined":case"function":te(e)===E&&(g=!0);break;case"integer":Number.isFinite(e)&&!(e%1)&&(g=!0);break;case"number":Number.isFinite(e)&&(g=!0);break;case"nonFinite":typeof e=="number"&&!Number.isFinite(e)&&(g=!0);break;case"object":e&&te(e)===E&&(g=!0);break;case"array":Array.isArray(e)&&(g=!0);break;case"other":g=this.currOtherTypeCallback(e,t,n,a);break;case"null":e===null&&(g=!0);break;default:throw new TypeError("Unknown value type "+E)}if(g)return _={path:t,value:e,parent:n,parentProperty:a},this._handleCallback(_,s,"value"),_}else if(A[0]==="`"&&e&&W.call(e,A.slice(1))){var j=A.slice(1);S(this._trace(P,e[j],fe(t,j),e,j,s,u,!0))}else if(A.includes(",")){var O=A.split(","),R=fn(O),G;try{for(R.s();!(G=R.n()).done;){var C=G.value;S(this._trace(Je(C,P),e,t,n,a,s,!0))}}catch(B){R.e(B)}finally{R.f()}}else!h&&e&&W.call(e,A)&&S(this._trace(P,e[A],fe(t,A),e,A,s,u,!0))}if(this._hasParentSelector)for(var $=0;$<w.length;$++){var M=w[$];if(M&&M.isParentSelector){var K=this._trace(M.expr,e,M.path,n,a,s,u);if(Array.isArray(K)){w[$]=K[0];for(var N=K.length,z=1;z<N;z++)$++,w.splice($,0,K[z])}else w[$]=K}}return w},U.prototype._walk=function(r,e){if(Array.isArray(r))for(var t=r.length,n=0;n<t;n++)e(n);else r&&te(r)==="object"&&Object.keys(r).forEach(function(a){e(a)})},U.prototype._slice=function(r,e,t,n,a,s,u){if(Array.isArray(t)){var h=t.length,p=r.split(":"),_=p[2]&&Number.parseInt(p[2])||1,A=p[0]&&Number.parseInt(p[0])||0,P=p[1]&&Number.parseInt(p[1])||h;A=A<0?Math.max(0,A+h):Math.min(h,A),P=P<0?Math.max(0,P+h):Math.min(h,P);for(var w=[],S=A;S<P;S+=_){var T=this._trace(Je(S,e),t,n,a,s,u,!0);T.forEach(function(g){w.push(g)})}return w}},U.prototype._eval=function(r,e,t,n,a,s){this.currSandbox._$_parentProperty=s,this.currSandbox._$_parent=a,this.currSandbox._$_property=t,this.currSandbox._$_root=this.json,this.currSandbox._$_v=e;var u=r.includes("@path");u&&(this.currSandbox._$_path=U.toPathString(n.concat([t])));var h="script:"+r;if(!U.cache[h]){var p=r.replace(/@parentProperty/g,"_$_parentProperty").replace(/@parent/g,"_$_parent").replace(/@property/g,"_$_property").replace(/@root/g,"_$_root").replace(/@([\t-\r \)\.\[\xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF])/g,"_$_v$1");u&&(p=p.replace(/@path/g,"_$_path")),U.cache[h]=new this.vm.Script(p)}try{return U.cache[h].runInNewContext(this.currSandbox)}catch(_){throw new Error("jsonPath: "+_.message+": "+r)}},U.cache={},U.toPathString=function(r){for(var e=r,t=e.length,n="$",a=1;a<t;a++)/^(~|\^|@(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\(\))$/.test(e[a])||(n+=/^[\*0-9]+$/.test(e[a])?"["+e[a]+"]":"['"+e[a]+"']");return n},U.toPointer=function(r){for(var e=r,t=e.length,n="",a=1;a<t;a++)/^(~|\^|@(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\(\))$/.test(e[a])||(n+="/"+e[a].toString().replace(/~/g,"~0").replace(/\//g,"~1"));return n},U.toPathArray=function(r){var e=U.cache;if(e[r])return e[r].concat();var t=[],n=r.replace(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/g,";$&;").replace(/['\[](\??\((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\))['\]]/g,function(s,u){return"[#"+(t.push(u)-1)+"]"}).replace(/\[["']((?:(?!['\]])[\s\S])*)["']\]/g,function(s,u){return"['"+u.replace(/\./g,"%@%").replace(/~/g,"%%@@%%")+"']"}).replace(/~/g,";~;").replace(/["']?\.["']?(?!(?:(?!\[)[\s\S])*\])|\[["']?/g,";").replace(/%@%/g,".").replace(/%%@@%%/g,"~").replace(/(?:;)?(\^+)(?:;)?/g,function(s,u){return";"+u.split("").join(";")+";"}).replace(/;;;|;;/g,";..;").replace(/;$|'?\]|'$/g,""),a=n.split(";").map(function(s){var u=s.match(/#([0-9]+)/);return!u||!u[1]?s:t[u[1]]});return e[r]=a,e[r].concat()};var dn=function(e,t,n){for(var a=e.length,s=0;s<a;s++){var u=e[s];n(u)&&t.push(e.splice(s--,1)[0])}},pn=function(){function r(e){_t(this,r),this.code=e}return Et(r,[{key:"runInNewContext",value:function(t){var n=this.code,a=Object.keys(t),s=[];dn(a,s,function(A){return typeof t[A]=="function"});var u=a.map(function(A,P){return t[A]}),h=s.reduce(function(A,P){var w=t[P].toString();return/function/.test(w)||(w="function "+w),"var "+P+"="+w+";"+A},"");n=h+n,!/(["'])use strict\1/.test(n)&&!a.includes("arguments")&&(n="var arguments = undefined;"+n),n=n.replace(/;[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*$/,"");var p=n.lastIndexOf(";"),_=p>-1?n.slice(0,p+1)+" return "+n.slice(p+1):" return "+n;return Te(Function,a.concat([_])).apply(void 0,on(u))}}]),r}();U.prototype.vm={Script:pn};const mn=Wt(Object.freeze(Object.defineProperty({__proto__:null,JSONPath:U},Symbol.toStringTag,{value:"Module"})));Object.defineProperty(De,"__esModule",{value:!0});var gn=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},vn=function(){function r(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),yn=we,We=Ye(yn),bn=Ge,An=ye,he=Ye(An),_n=mn,wn=vt,Ot=Ye(wn);function Ye(r){return r&&r.__esModule?r:{default:r}}function En(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Sn(r,e){return(0,_n.JSONPath)({path:e,json:r,wrap:!1})}var Pn=function(){function r(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};En(this,r),this.factMap=new Map,this.factResultsCache=new Map,this.allowUndefinedFacts=!!e.allowUndefinedFacts,this.pathResolver=e.pathResolver||Sn,this.events={success:[],failure:[]},this.ruleResults=[]}return vn(r,[{key:"addEvent",value:function(t,n){if(!n)throw new Error('outcome required: "success" | "failure"]');this.events[n].push(t)}},{key:"getEvents",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"";return t?this.events[t]:this.events.success.concat(this.events.failure)}},{key:"addResult",value:function(t){this.ruleResults.push(t)}},{key:"getResults",value:function(){return this.ruleResults}},{key:"_getFact",value:function(t){return this.factMap.get(t)}},{key:"_addConstantFact",value:function(t){this.factMap.set(t.id,t),this._setFactValue(t,{},t.value)}},{key:"_setFactValue",value:function(t,n,a){var s=t.getCacheKey(n),u=Promise.resolve(a);return s&&this.factResultsCache.set(s,u),u}},{key:"addFact",value:function(t,n,a){var s=t,u=void 0;return t instanceof We.default?(s=t.id,u=t):u=new We.default(t,n,a),(0,he.default)("almanac::addFact id:"+s),this.factMap.set(s,u),u.isConstant()&&this._setFactValue(u,{},u.value),this}},{key:"addRuntimeFact",value:function(t,n){(0,he.default)("almanac::addRuntimeFact id:"+t);var a=new We.default(t,n);return this._addConstantFact(a)}},{key:"factValue",value:function(t){var n=this,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"",u=void 0,h=this._getFact(t);if(h===void 0)return this.allowUndefinedFacts?Promise.resolve(void 0):Promise.reject(new bn.UndefinedFactError("Undefined fact: "+t));if(h.isConstant())u=Promise.resolve(h.calculate(a,this));else{var p=h.getCacheKey(a),_=p&&this.factResultsCache.get(p);_?(u=Promise.resolve(_),(0,he.default)("almanac::factValue cache hit for fact:"+t)):((0,he.default)("almanac::factValue cache miss for fact:"+t+"; calculating"),u=this._setFactValue(h,a,h.calculate(a,this)))}return s?((0,he.default)("condition::evaluate extracting object property "+s),u.then(function(A){if((0,Ot.default)(A)){var P=n.pathResolver(A,s);return(0,he.default)("condition::evaluate extracting object property "+s+", received: "+JSON.stringify(P)),P}else return(0,he.default)("condition::evaluate could not compute object path("+s+") of non-object: "+A+" <"+(typeof A>"u"?"undefined":gn(A))+">; continuing with "+A),A})):u}},{key:"getValue",value:function(t){return(0,Ot.default)(t)&&Object.prototype.hasOwnProperty.call(t,"fact")?this.factValue(t.fact,t.params,t.path):Promise.resolve(t)}}]),r}();De.default=Pn;var Ze={};Object.defineProperty(Ze,"__esModule",{value:!0});var On=Oe,re=kn(On);function kn(r){return r&&r.__esModule?r:{default:r}}var Q=[];Q.push(new re.default("equal",function(r,e){return r===e})),Q.push(new re.default("notEqual",function(r,e){return r!==e})),Q.push(new re.default("in",function(r,e){return e.indexOf(r)>-1})),Q.push(new re.default("notIn",function(r,e){return e.indexOf(r)===-1})),Q.push(new re.default("contains",function(r,e){return r.indexOf(e)>-1},Array.isArray)),Q.push(new re.default("doesNotContain",function(r,e){return r.indexOf(e)===-1},Array.isArray));function Ue(r){return Number.parseFloat(r).toString()!=="NaN"}Q.push(new re.default("lessThan",function(r,e){return r<e},Ue)),Q.push(new re.default("lessThanInclusive",function(r,e){return r<=e},Ue)),Q.push(new re.default("greaterThan",function(r,e){return r>e},Ue)),Q.push(new re.default("greaterThanInclusive",function(r,e){return r>=e},Ue)),Ze.default=Q,Object.defineProperty(ne,"__esModule",{value:!0}),ne.FINISHED=ne.RUNNING=ne.READY=void 0;var Cn=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},Tn=function(){function r(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),jn=we,je=oe(jn),In=Me,Qe=oe(In),Fn=Oe,Xe=oe(Fn),Rn=De,Mn=oe(Rn),Nn=At,Ln=oe(Nn),Dn=Ze,Un=oe(Dn),Bn=ye,de=oe(Bn),xn=Ne,$n=oe(xn);function oe(r){return r&&r.__esModule?r:{default:r}}function zn(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Hn(r,e){if(!r)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:r}function Vn(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(r,e):r.__proto__=e)}var Gn=ne.READY="READY",kt=ne.RUNNING="RUNNING",Ct=ne.FINISHED="FINISHED",qn=function(r){Vn(e,r);function e(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};zn(this,e);var a=Hn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a.rules=[],a.allowUndefinedFacts=n.allowUndefinedFacts||!1,a.allowUndefinedConditions=n.allowUndefinedConditions||!1,a.replaceFactsInEventParams=n.replaceFactsInEventParams||!1,a.pathResolver=n.pathResolver,a.operators=new Map,a.facts=new Map,a.conditions=new Map,a.status=Gn,t.map(function(s){return a.addRule(s)}),Un.default.map(function(s){return a.addOperator(s)}),a}return Tn(e,[{key:"addRule",value:function(n){if(!n)throw new Error("Engine: addRule() requires options");var a=void 0;if(n instanceof Qe.default)a=n;else{if(!Object.prototype.hasOwnProperty.call(n,"event"))throw new Error('Engine: addRule() argument requires "event" property');if(!Object.prototype.hasOwnProperty.call(n,"conditions"))throw new Error('Engine: addRule() argument requires "conditions" property');a=new Qe.default(n)}return a.setEngine(this),this.rules.push(a),this.prioritizedRules=null,this}},{key:"updateRule",value:function(n){var a=this.rules.findIndex(function(s){return s.name===n.name});if(a>-1)this.rules.splice(a,1),this.addRule(n),this.prioritizedRules=null;else throw new Error("Engine: updateRule() rule not found")}},{key:"removeRule",value:function(n){var a=!1;if(n instanceof Qe.default){var u=this.rules.indexOf(n);u>-1&&(a=!!this.rules.splice(u,1).length)}else{var s=this.rules.filter(function(h){return h.name!==n});a=s.length!==this.rules.length,this.rules=s}return a&&(this.prioritizedRules=null),a}},{key:"setCondition",value:function(n,a){if(!n)throw new Error("Engine: setCondition() requires name");if(!a)throw new Error("Engine: setCondition() requires conditions");if(!Object.prototype.hasOwnProperty.call(a,"all")&&!Object.prototype.hasOwnProperty.call(a,"any")&&!Object.prototype.hasOwnProperty.call(a,"not")&&!Object.prototype.hasOwnProperty.call(a,"condition"))throw new Error('"conditions" root must contain a single instance of "all", "any", "not", or "condition"');return this.conditions.set(n,new $n.default(a)),this}},{key:"removeCondition",value:function(n){return this.conditions.delete(n)}},{key:"addOperator",value:function(n,a){var s=void 0;n instanceof Xe.default?s=n:s=new Xe.default(n,a),(0,de.default)("engine::addOperator name:"+s.name),this.operators.set(s.name,s)}},{key:"removeOperator",value:function(n){var a=void 0;return n instanceof Xe.default?a=n.name:a=n,this.operators.delete(a)}},{key:"addFact",value:function(n,a,s){var u=n,h=void 0;return n instanceof je.default?(u=n.id,h=n):h=new je.default(n,a,s),(0,de.default)("engine::addFact id:"+u),this.facts.set(u,h),this}},{key:"removeFact",value:function(n){var a=void 0;return n instanceof je.default?a=n.id:a=n,this.facts.delete(a)}},{key:"prioritizeRules",value:function(){if(!this.prioritizedRules){var n=this.rules.reduce(function(a,s){var u=s.priority;return a[u]||(a[u]=[]),a[u].push(s),a},{});this.prioritizedRules=Object.keys(n).sort(function(a,s){return Number(a)>Number(s)?-1:1}).map(function(a){return n[a]})}return this.prioritizedRules}},{key:"stop",value:function(){return this.status=Ct,this}},{key:"getFact",value:function(n){return this.facts.get(n)}},{key:"evaluateRules",value:function(n,a){var s=this;return Promise.all(n.map(function(u){return s.status!==kt?((0,de.default)("engine::run status:"+s.status+"; skipping remaining rules"),Promise.resolve()):u.evaluate(a).then(function(h){return(0,de.default)("engine::run ruleResult:"+h.result),a.addResult(h),h.result?(a.addEvent(h.event,"success"),s.emitAsync("success",h.event,a,h).then(function(){return s.emitAsync(h.event.type,h.event.params,a,h)})):(a.addEvent(h.event,"failure"),s.emitAsync("failure",h.event,a,h))})}))}},{key:"run",value:function(){var n=this,a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};(0,de.default)("engine::run started"),this.status=kt;var u=s.almanac||new Mn.default({allowUndefinedFacts:this.allowUndefinedFacts,pathResolver:this.pathResolver});this.facts.forEach(function(P){u.addFact(P)});for(var h in a){var p=void 0;a[h]instanceof je.default?p=a[h]:p=new je.default(h,a[h]),u.addFact(p),(0,de.default)("engine::run initialized runtime fact:"+p.id+" with "+p.value+"<"+Cn(p.value)+">")}var _=this.prioritizeRules(),A=Promise.resolve();return new Promise(function(P,w){_.map(function(S){return A=A.then(function(){return n.evaluateRules(S,u)}).catch(w),A}),A.then(function(){n.status=Ct,(0,de.default)("engine::run completed");var S=u.getResults(),T=S.reduce(function(j,O){var R=O.result?"results":"failureResults";return j[R].push(O),j},{results:[],failureResults:[]}),g=T.results,E=T.failureResults;P({almanac:u,results:g,failureResults:E,events:u.getEvents("success"),failureEvents:u.getEvents("failure")})}).catch(w)})}}]),e}(Ln.default);ne.default=qn,Object.defineProperty(Z,"__esModule",{value:!0}),Z.Almanac=Z.Engine=Z.Operator=Z.Rule=Z.Fact=void 0,Z.default=function(r,e){return new Tt.default(r,e)};var Kn=ne,Tt=Ie(Kn),Jn=we,Wn=Ie(Jn),Yn=Me,Zn=Ie(Yn),Qn=Oe,Xn=Ie(Qn),ea=De,ta=Ie(ea);function Ie(r){return r&&r.__esModule?r:{default:r}}Z.Fact=Wn.default,Z.Rule=Zn.default,Z.Operator=Xn.default,Z.Engine=Tt.default,Z.Almanac=ta.default;var ra=Z,ae=(r=>(r.FREQUENCY="frequency",r.SPENT_ON_PAGE="spent_on_page",r.SPENT_ON_SITE="spent_on_site",r.LANGUAGE="language",r.URL_SPECIFIC="url_specification",r.LOCATION="location",r.VISITOR="visitor",r))(ae||{});class pe{constructor(e){F(this,"rule",{fact:ae.FREQUENCY,operator:"",value:"",params:{}});this.name=e,this.name=e}getFact(){return{[this.name]:this.findFact()}}getFactValue(){return{[this.name]:this.findFact().value}}findFact(){return this.rule}}class na extends pe{constructor(t,n){super(t);F(this,"mainState",H.getInstance().getState("main-state"));this.name=t,this.fact=n}createFact(){const t={fact:this.name,operator:this.fact.operator||"equals",value:this.getUserTimeZone()||"",params:this.fact.params||{}};return this.rule=t,this}getUserTimeZone(){var t,n;try{return((t=this.mainState.getState())==null?void 0:t.country)||((n=Re())==null?void 0:n.userCountry)}catch{}}}class aa extends pe{constructor(e,t,n){super(e),this.name=e,this.fact=t,this.store=n}createFact(){const e={fact:this.name,operator:this.fact.operator||"equals",value:this.prepareFactValue(),params:this.fact.params||{}};return this.rule=e,this}prepareFactValue(){var a,s,u,h;const e=this.store.getState().store.totalSeen,t=((s=(a=this.fact.params)==null?void 0:a.time_delay)==null?void 0:s.value)||1;return t===1&&e>1?1:this.isDurationPassed(this.store.getState().store.lastSeen,t,((h=(u=this.fact.params)==null?void 0:u.time_delay)==null?void 0:h.unit)||"seconds")&&e<Number(this.fact.value)?this.fact.value:e||0}isDurationPassed(e,t,n){const a=Date.now();let s;switch(n){case"days":s=t*24*60*60*1e3;break;case"hours":s=t*60*60*1e3;break;case"minutes":s=t*60*1e3;break;case"seconds":s=t*1e3;break;default:throw new Error("Invalid time unit")}return e===0?!0:a-e>=s}}class ia extends pe{constructor(t,n){super(t);F(this,"mainState",H.getInstance().getState("main-state"));this.name=t,this.fact=n}createFact(){const t={fact:this.name,operator:this.fact.operator||"equals",value:this.getUserLanguage()||"",params:this.fact.params||{}};return this.rule=t,this}getUserLanguage(){var t;try{return((t=this.mainState.getState())==null?void 0:t.language)||ut()}catch{}}}var jt={exports:{}};(function(r){(()=>{((e,t)=>r.exports?r.exports=t():e.TimeMe=t())(this,()=>{let e={startStopTimes:{},idleTimeoutMs:3e4,currentIdleTimeMs:0,checkIdleStateRateMs:250,isUserCurrentlyOnPage:!0,isUserCurrentlyIdle:!1,currentPageName:"default-page-name",timeElapsedCallbacks:[],userLeftCallbacks:[],userReturnCallbacks:[],trackTimeOnElement:t=>{let n=document.getElementById(t);n&&(n.addEventListener("mouseover",()=>{e.startTimer(t)}),n.addEventListener("mousemove",()=>{e.startTimer(t)}),n.addEventListener("mouseleave",()=>{e.stopTimer(t)}),n.addEventListener("keypress",()=>{e.startTimer(t)}),n.addEventListener("focus",()=>{e.startTimer(t)}))},getTimeOnElementInSeconds:t=>{let n=e.getTimeOnPageInSeconds(t);return n||0},startTimer:(t,n)=>{if(t||(t=e.currentPageName),e.startStopTimes[t]===void 0)e.startStopTimes[t]=[];else{let a=e.startStopTimes[t],s=a[a.length-1];if(s!==void 0&&s.stopTime===void 0)return}e.startStopTimes[t].push({startTime:n||new Date,stopTime:void 0})},stopAllTimers:()=>{let t=Object.keys(e.startStopTimes);for(let n=0;n<t.length;n++)e.stopTimer(t[n])},stopTimer:(t,n)=>{t||(t=e.currentPageName);let a=e.startStopTimes[t];a===void 0||a.length===0||a[a.length-1].stopTime===void 0&&(a[a.length-1].stopTime=n||new Date)},getTimeOnCurrentPageInSeconds:()=>e.getTimeOnPageInSeconds(e.currentPageName),getTimeOnPageInSeconds:t=>{let n=e.getTimeOnPageInMilliseconds(t);if(n!==void 0)return n/1e3},getTimeOnCurrentPageInMilliseconds:()=>e.getTimeOnPageInMilliseconds(e.currentPageName),getTimeOnPageInMilliseconds:t=>{let n=0,a=e.startStopTimes[t];if(a===void 0)return;let s=0;for(let u=0;u<a.length;u++){let h=a[u].startTime,p=a[u].stopTime;p===void 0&&(p=new Date);let _=p-h;s+=_}return n=Number(s),n},getTimeOnAllPagesInSeconds:()=>{let t=[],n=Object.keys(e.startStopTimes);for(let a=0;a<n.length;a++){let s=n[a],u=e.getTimeOnPageInSeconds(s);t.push({pageName:s,timeOnPage:u})}return t},setIdleDurationInSeconds:t=>{let n=parseFloat(t);if(isNaN(n)===!1)e.idleTimeoutMs=t*1e3;else throw{name:"InvalidDurationException",message:"An invalid duration time ("+t+") was provided."}},setCurrentPageName:t=>{e.currentPageName=t},resetRecordedPageTime:t=>{delete e.startStopTimes[t]},resetAllRecordedPageTimes:()=>{let t=Object.keys(e.startStopTimes);for(let n=0;n<t.length;n++)e.resetRecordedPageTime(t[n])},userActivityDetected:()=>{e.isUserCurrentlyIdle&&e.triggerUserHasReturned(),e.resetIdleCountdown()},resetIdleCountdown:()=>{e.isUserCurrentlyIdle=!1,e.currentIdleTimeMs=0},callWhenUserLeaves:(t,n)=>{e.userLeftCallbacks.push({callback:t,numberOfTimesToInvoke:n})},callWhenUserReturns:(t,n)=>{e.userReturnCallbacks.push({callback:t,numberOfTimesToInvoke:n})},triggerUserHasReturned:()=>{if(!e.isUserCurrentlyOnPage){e.isUserCurrentlyOnPage=!0,e.resetIdleCountdown();for(let t=0;t<e.userReturnCallbacks.length;t++){let n=e.userReturnCallbacks[t],a=n.numberOfTimesToInvoke;(isNaN(a)||a===void 0||a>0)&&(n.numberOfTimesToInvoke-=1,n.callback())}}e.startTimer()},triggerUserHasLeftPageOrGoneIdle:()=>{if(e.isUserCurrentlyOnPage){e.isUserCurrentlyOnPage=!1;for(let t=0;t<e.userLeftCallbacks.length;t++){let n=e.userLeftCallbacks[t],a=n.numberOfTimesToInvoke;(isNaN(a)||a===void 0||a>0)&&(n.numberOfTimesToInvoke-=1,n.callback())}}e.stopAllTimers()},callAfterTimeElapsedInSeconds:(t,n)=>{e.timeElapsedCallbacks.push({timeInSeconds:t,callback:n,pending:!0})},checkIdleState:()=>{for(let t=0;t<e.timeElapsedCallbacks.length;t++)e.timeElapsedCallbacks[t].pending&&e.getTimeOnCurrentPageInSeconds()>e.timeElapsedCallbacks[t].timeInSeconds&&(e.timeElapsedCallbacks[t].callback(),e.timeElapsedCallbacks[t].pending=!1);e.isUserCurrentlyIdle===!1&&e.currentIdleTimeMs>e.idleTimeoutMs?(e.isUserCurrentlyIdle=!0,e.triggerUserHasLeftPageOrGoneIdle()):e.currentIdleTimeMs+=e.checkIdleStateRateMs},visibilityChangeEventName:void 0,hiddenPropName:void 0,listenForVisibilityEvents:(t,n)=>{t&&e.listenForUserLeavesOrReturnsEvents(),n&&e.listForIdleEvents()},listenForUserLeavesOrReturnsEvents:()=>{typeof document.hidden<"u"?(e.hiddenPropName="hidden",e.visibilityChangeEventName="visibilitychange"):typeof document.mozHidden<"u"?(e.hiddenPropName="mozHidden",e.visibilityChangeEventName="mozvisibilitychange"):typeof document.msHidden<"u"?(e.hiddenPropName="msHidden",e.visibilityChangeEventName="msvisibilitychange"):typeof document.webkitHidden<"u"&&(e.hiddenPropName="webkitHidden",e.visibilityChangeEventName="webkitvisibilitychange"),document.addEventListener(e.visibilityChangeEventName,()=>{document[e.hiddenPropName]?e.triggerUserHasLeftPageOrGoneIdle():e.triggerUserHasReturned()},!1),window.addEventListener("blur",()=>{e.triggerUserHasLeftPageOrGoneIdle()}),window.addEventListener("focus",()=>{e.triggerUserHasReturned()})},listForIdleEvents:()=>{document.addEventListener("mousemove",()=>{e.userActivityDetected()}),document.addEventListener("keyup",()=>{e.userActivityDetected()}),document.addEventListener("touchstart",()=>{e.userActivityDetected()}),window.addEventListener("scroll",()=>{e.userActivityDetected()}),setInterval(()=>{e.isUserCurrentlyIdle!==!0&&e.checkIdleState()},e.checkIdleStateRateMs)},websocket:void 0,websocketHost:void 0,setUpWebsocket:t=>{if(window.WebSocket&&t){let n=t.websocketHost;try{e.websocket=new WebSocket(n),window.onbeforeunload=()=>{e.sendCurrentTime(t.appId)},e.websocket.onopen=()=>{e.sendInitWsRequest(t.appId)},e.websocket.onerror=a=>{console&&console.log("Error occurred in websocket connection: "+a)},e.websocket.onmessage=a=>{console&&console.log(a.data)}}catch(a){console&&console.error("Failed to connect to websocket host.  Error:"+a)}}},websocketSend:t=>{e.websocket.send(JSON.stringify(t))},sendCurrentTime:t=>{let n=e.getTimeOnCurrentPageInMilliseconds(),a={type:"INSERT_TIME",appId:t,timeOnPageMs:n,pageName:e.currentPageName};e.websocketSend(a)},sendInitWsRequest:t=>{let n={type:"INIT",appId:t};e.websocketSend(n)},initialize:t=>{let n=e.idleTimeoutMs||30,a=e.currentPageName||"default-page-name",s,u,h=!0,p=!0;t&&(n=t.idleTimeoutInSeconds||n,a=t.currentPageName||a,s=t.websocketOptions,u=t.initialStartTime,t.trackWhenUserLeavesPage===!1&&(h=!1),t.trackWhenUserGoesIdle===!1&&(p=!1)),e.setIdleDurationInSeconds(n),e.setCurrentPageName(a),e.setUpWebsocket(s),e.listenForVisibilityEvents(h,p),e.startTimer(void 0,u)}};return e})}).call(Kt)})(jt);var sa=jt.exports;const be=Jt(sa);class oa extends pe{constructor(e,t){super(e),this.name=e,this.fact=t}createFact(){const e={fact:this.name,operator:this.fact.operator||"equals",value:this.getSpentTimeOnPage()||"",params:this.fact.params||{}};return this.rule=e,this}getSpentTimeOnPage(){try{const e=window.location.pathname;be.initialize({...e.length===1?{}:{currentPageName:e}});const t=be.getTimeOnCurrentPageInSeconds();return e.length!==1?Math.floor(t):0}catch{}}}class ua extends pe{constructor(e,t){super(e),this.name=e,this.fact=t}createFact(){const e={fact:this.name,operator:this.fact.operator||"equals",value:this.getSpentTimeOnSite()||"",params:this.fact.params||{}};return this.rule=e,this}getSpentTimeOnSite(){try{const e=window.location.pathname;be.initialize({currentPageName:"/"});const t=be.getTimeOnCurrentPageInSeconds();return e.length===1?Math.floor(t):0}catch{}}}class ca extends pe{constructor(e,t){super(e),this.name=e,this.fact=t}createFact(){const e={fact:this.name,operator:this.fact.operator||"equals",value:this.getPagePathURL()||"",params:this.fact.params||{}};return this.rule=e,this}getPagePathURL(){try{return window.location.pathname.trim()}catch{}}}class la extends pe{constructor(t,n){super(t);F(this,"mainState",H.getInstance().getState("main-state"));this.name=t,this.fact=n}createFact(){const t={fact:this.name,operator:this.fact.operator||"equals",value:this.isUserNewOrOld()||"",params:this.fact.params||{}};return this.rule=t,this}isUserNewOrOld(){var t;try{const n=ot("rtl-gid")?"returning-user":"new-user";return n==="new-user"&&st("rtl-gid",`${Math.floor(Math.random()*100)}:${Date.now()}`,30),((t=this.mainState.getState())==null?void 0:t.isNewUser)||n}catch{}}}class fa{create(e,t,n){switch(e){case ae.FREQUENCY:return new aa(e,t,n);case ae.SPENT_ON_PAGE:return new oa(e,t);case ae.SPENT_ON_SITE:return new ua(e,t);case ae.LANGUAGE:return new ia(e,t);case ae.URL_SPECIFIC:return new ca(e,t);case ae.LOCATION:return new na(e,t);case ae.VISITOR:return new la(e,t)}}}class ha{constructor(){F(this,"isFactsValidateNeeded",!1);F(this,"factFactory");F(this,"facts",[]);F(this,"rules");F(this,"frequency",!1);F(this,"appContext",H.getInstance());F(this,"store",this.appContext.getState("app-state"));F(this,"data",this.appContext.getState("data"));console.log({fact:this.data}),this.setUpStoreRules(),this.rules=this.data.rules,this.factFactory=new fa}setUpStoreRules(){this.store.setState(e=>({...e,store:{...e.store,rules:this.data.rules}}))}create(){const e=Object.keys(this.rules);if(e.length!==1)throw new Error("Invalid facts list provided");if(ee(e))return;const t=this.rules[e[0]],n=(t==null?void 0:t.map(a=>(a.fact==="frequency"&&(this.frequency=!0),this.factFactory.create(a.fact,a,this.store))))||[];ee(n)||(this.isFactsValidateNeeded=!0),this.facts=n}generateFacts(){var e;return(e=this.facts)==null?void 0:e.map(t=>({...t==null?void 0:t.createFact().getFact()[t.name]}))}currentFacts(){var n,a;const e={},t=(a=(n=this.facts)==null?void 0:n.map(s=>({...s==null?void 0:s.createFact().getFactValue()})))==null?void 0:a.filter(s=>!!s);return t==null||t.map(s=>{const u=Object.keys(s)[0];e[u]=s[u]}),e}async validate(e){const t=new ra.Engine;t.addRule({conditions:this.rules,event:{type:"showPopup",params:{message:"Popup should be shown"}}});let n=!1;return await t.run(e).then(({events:a})=>{a.map(s=>{s.type==="showPopup"&&(n=!0)})}),!!n}getRules(){return this.rules}isFrequencyEnabled(){return this.frequency}}class da{createElement(e){try{return Vt(e)}catch{return null}}}class pa{constructor(e,t,n){F(this,"elementBuilder",new da);F(this,"store",H.getInstance().getState("app-state"));F(this,"http",new X);this.componentData=e,this.portal=t,this.launcher=n}setupPhases(){const e=this.componentData.phases.map(a=>this.createPhaseObject(a.id)),t=this.store.getState().store.phases,n=e.reduce((a,s)=>{const u=Object.keys(s)[0];return a[u]={...s[u]},a},{});this.store.setState(a=>({...a,store:{...a.store,phases:ee(t)?n:a.store.phases,currentPhase:Object.keys(n)[0]}}))}createPhaseObject(e){return{[e]:{name:e,isCompleted:!1}}}phaseSwap(){const e=this.getCurrentPhase(),t=this.getPhases();if(!e)return null;const n=this.checkIfPhaseIsCompleted(e);if(!n){this.setupNotCompletedPhaseElement(e);return}if(n){this.setupCompletedPhaseElement(e,t);return}}setupCompletedPhaseElement(e,t){const n=this.getNextPhase(e,t),a=this.getNextPhaseElement(n.name||"");if(!a)return null;const s=this.elementBuilder.createElement(a.html);this.portal.appendElementToPortal(s,a.id),this.setPhaseEvent(a,s,async(u,h)=>{switch(u.preventDefault(),h){case"form":await this.saveFormData(u,a);break}}),this.updateCurrentPhase((a==null?void 0:a.id)||"")}setupNotCompletedPhaseElement(e){const t=this.getNextPhaseElement(e);if(!t)return null;const n=this.elementBuilder.createElement(t.html);this.portal.appendElementToPortal(n,t.id),this.setPhaseEvent(t,n,async(a,s)=>{switch(a.preventDefault(),s){case"form":await this.saveFormData(a,t);break}}),this.updateCurrentPhase((t==null?void 0:t.id)||"")}getPhases(){return this.store.getState().store.phases}getNextPhaseElement(e){return this.componentData.phases.find(t=>t.id===e)}getNextPhaseById(e){return this.componentData.phases.find(t=>t.id===e)}getCurrentPhase(){var e;try{const t=this.store.getState().store.currentPhase,n=this.portal.getPortal();return ee(t)?(e=n==null?void 0:n.firstElementChild)==null?void 0:e.id:t}catch{}}updateCurrentPhase(e){return this.store.setState(t=>({...t,store:{...t.store,currentPhase:e}}))}checkIfPhaseIsCompleted(e){return this.store.getState().store.phases[e].isCompleted}getNextPhase(e,t){const n=Object.keys(t),a=n.indexOf(e);if(a>=0&&a<n.length-1){const s=n[a+1];return t[s]}return null}setPhase(e,t){this.portal.appendElementToPortal(e,t)}setPhaseEvent(e,t,n){if(typeof t=="string")return t;switch(this.addElementEvents(t),e.type){case"form":{t.querySelector("form").addEventListener("submit",s=>n(s,e.type));break}}return t}async saveFormData(e,t){try{const n=new FormData(e.target),a={id:Math.floor(Math.random()*1e3)};for(const[h,p]of n.entries())a[h]=p;if(await this.http.post("/customers",JSON.stringify(a)),!this.getNextPhase(t.id,this.store.getState().store.phases))return null;const u=this.store.getState().store.phases[t.id];this.store.setState(h=>({...h,store:{...h.store,phases:{...h.store.phases,[u.name]:{...u,isCompleted:!0}}}})),this==null||this.phaseSwap()}catch{return null}}addElementEvents(e){if(typeof e=="string")return;const t='[data-type="close"]';try{const n=e.querySelectorAll(t);if(!n)return;n.forEach(a=>a.addEventListener("click",()=>{this.launcher.close()}))}catch{}}}class ma{constructor(e){this.id=e,this.id=`${e}`}createPortal(){const e=document.createElement("div");return e.id=this.id,e}addPortalToDom(e){document.body.appendChild(e)}destroy(){try{document.getElementById(this.id).remove()}catch{console.warn("Portal not found")}}appendElementToPortal(e,t){try{let n=document.getElementById(this.id);if(typeof e!="string"&&e){e.id=t,n=this.removeFirstChild(n),n.appendChild(e);return}n.innerHTML=e}catch{console.warn("Portal not found")}}removeFirstChild(e){return e.firstChild&&e.removeChild(e.firstChild),e}getPortal(){return document.getElementById(this.id)}}class ga{constructor(){F(this,"portalId","protal");F(this,"phase");F(this,"appContext",H.getInstance());F(this,"store",this.appContext.getState("app-state"));F(this,"componentData",this.appContext.getState("data"));F(this,"id",((Rt=(Ft=this.appContext.getState("data"))==null?void 0:Ft.my_account)==null?void 0:Rt.id)||"");this.portalId=`${this.id}-portal`}async launch(){var e;try{if(!Array.isArray(this.componentData)){this.setUpTeaser(this.componentData.teaser);const t=new ma(this.portalId);this.phase=new pa(this.componentData,t,this),this.phase.setupPhases();const n=t.createPortal();n.style.display="none",t.addPortalToDom(n);const a=(e=this.componentData.wrapper)==null?void 0:e.style.split(";").reduce((s,u)=>{if(u.trim()==="")return s;const[h,p]=u.split(":");return s[h.trim()]=p.trim(),s},{});return Ht(n.style,{...a}),{open:()=>this.open(),close:()=>this.close(),destroy:()=>this.destroy(),uIid:this.portalId}}console.log("UI not Initialised");return}catch{console.warn("Failed to launch")}}open(){const e=document.getElementById(this.portalId);if(e&&e.style.display!=="flex"){this.phase&&this.phase.phaseSwap();try{e.style.display="flex",this.updateLastSeenAndTotal()}catch{console.warn("Element not initialized")}}}close(){const e=document.getElementById(this.portalId);try{e.style.display="none"}catch(t){console.log(t)}}destroy(){try{document.getElementById(this.portalId).remove()}catch(e){console.warn(e)}}isTeaserEnabled(e){return(e==null?void 0:e.enabled)||!1}setUpTeaser(e){try{if(!this.isTeaserEnabled(e))return null;document.body.insertAdjacentHTML("beforeend",e.html),this.getDataAttributeElements('[data-type="teaser"]').forEach(n=>{this.addTeaserId(n),this.addTeaserClickEvent(n)})}catch{return null}}addTeaserClickEvent(e){e.onclick||(e.onclick=()=>this.open())}addTeaserId(e){e.id||(e.id=this.id)}getDataAttributeElements(e){return document.querySelectorAll(e)}updateLastSeenAndTotal(){this.store.setState(e=>({...e,store:{...e.store,totalSeen:++e.store.totalSeen,lastSeen:Date.now()}}))}}class va{constructor(e,t,n){this.launcher=e,this.fact=t,this.trigger=n,this.addTrigger()}addTrigger(){var e,t,n;(e=this.trigger)!=null&&e.is_enabled&&((n=(t=this.trigger)==null?void 0:t.value)==null||n.map(a=>this.add(a)))}add(e){const{attribute:t,attribute_value:n}=e,a=this.getElement(t,n);a&&this.addClickListener(a)}getValueAttribute(e,t){switch(e){case"id":return`#${t}`;case"class":return`.${t}`}}getElement(e,t){return document.querySelector(this.getValueAttribute(e,t))}addClickListener(e){e.addEventListener("click",()=>{this.update()})}update(){if(!this.fact.isFactsValidateNeeded)return this.launcher.open();const e=this.fact.currentFacts();this.fact.validate(e).then(t=>{if(t)return this.launcher.open()}).catch(()=>null)}}class ya{constructor(e,t,n){this.launcher=e,this.fact=t,this.trigger=n,this.addTrigger()}addTrigger(){var e,t,n;(e=this.trigger)!=null&&e.is_enabled&&((n=(t=this.trigger)==null?void 0:t.value)==null||n.map(a=>this.add(a)))}add(e){const{attribute:t,attribute_value:n}=e,a=this.getElement(t,n);a&&this.addClickListener(a)}getValueAttribute(e,t){switch(e){case"id":return`#${t}`;case"class":return`.${t}`}}getElement(e,t){return document.querySelector(this.getValueAttribute(e,t))}addClickListener(e){e.addEventListener("click",()=>{this.update()})}update(){if(!this.fact.isFactsValidateNeeded)return this.launcher.open();const e=this.fact.currentFacts();this.fact.validate(e).then(t=>{if(t)return this.launcher.open()}).catch(()=>null)}}class ba{constructor(e,t,n){this.launcher=e,this.fact=t,this.trigger=n,this.addTrigger()}addTrigger(){var e;(e=this.trigger)!=null&&e.is_enabled&&this.add()}add(){this.exitIntentListener()}exitIntentListener(){document.addEventListener("mouseout",e=>{(e.clientY<=0||e.clientX<=0||e.clientX>=window.innerWidth||e.clientY>=window.innerHeight)&&(console.log("I'm out"),this.update())})}update(){if(!this.fact.isFactsValidateNeeded)return this.launcher.open();const e=this.fact.currentFacts();this.fact.validate(e).then(t=>{if(t)return this.launcher.open()}).catch(()=>null)}}class Aa{constructor(e,t,n){F(this,"idleTimeout");this.launcher=e,this.fact=t,this.trigger=n,this.addTrigger()}addTrigger(){var e;(e=this.trigger)!=null&&e.is_enabled&&this.add()}add(){this.idleTimedListener()}idleTimedListener(){this.resetTimeOut(),document.addEventListener("mousemove",()=>{this.resetTimeOut()}),document.addEventListener("keydown",()=>{this.resetTimeOut()}),document.addEventListener("click",()=>{this.resetTimeOut()}),document.addEventListener("scroll",()=>{this.resetTimeOut()})}resetTimeOut(){try{const e=this.trigger.value;this.idleTimeout&&clearTimeout(this.idleTimeout),this.idleTimeout=setTimeout(()=>{console.log("User is idle"),this.update(),this.clearTimeout()},e*1e3)}catch{}}update(){if(!this.fact.isFactsValidateNeeded)return this.launcher.open();const e=this.fact.currentFacts();this.fact.validate(e).then(t=>{if(t)return this.launcher.open()}).catch(()=>null)}clearTimeout(){this.idleTimeout&&clearTimeout(this.idleTimeout)}}class _a{constructor(e,t,n){F(this,"scrollCount",0);this.launcher=e,this.fact=t,this.trigger=n,this.addTrigger()}addTrigger(){var e;(e=this.trigger)!=null&&e.is_enabled&&this.add()}add(){this.scrollEventListener()}scrollEventListener(){document.addEventListener("scrollend",()=>{this.updateScroll(),this.update()})}updateScroll(){const e=window.pageYOffset||document.documentElement.scrollTop,t=document.documentElement.scrollHeight-document.documentElement.clientHeight,n=e/t*100;n&&(this.scrollCount=Math.floor(n))}update(){if(this.scrollCount>=this.trigger.value){if(!this.fact.isFactsValidateNeeded)return this.launcher.open();const e=this.fact.currentFacts();this.fact.validate(e).then(t=>{if(t)return this.launcher.open()}).catch(()=>null)}}}class wa{constructor(e,t,n){this.launcher=e,this.fact=t,this.trigger=n,this.addTrigger()}addTrigger(){var e;(e=this.trigger)!=null&&e.is_enabled&&this.add()}add(){this.idleTimedListener()}idleTimedListener(){try{be.initialize(),be.callAfterTimeElapsedInSeconds(this.trigger.value,()=>{this.update()})}catch{}}update(){if(!this.fact.isFactsValidateNeeded)return this.launcher.open();const e=this.fact.currentFacts();this.fact.validate(e).then(t=>{if(t)return this.launcher.open()}).catch(()=>null)}}class Ea{constructor(e,t,n,a){this.triggerList=e,this.launcher=t,this.fact=n,this.triggers=a}create(){this.triggerList.forEach(e=>{this.createTrigger(e)})}createTrigger(e){switch(e){case"add_to_cart":return new va(this.launcher,this.fact,this.triggers[e]);case"click":return new ya(this.launcher,this.fact,this.triggers[e]);case"exit_intent":return new ba(this.launcher,this.fact,this.triggers[e]);case"idle_timeout":return new Aa(this.launcher,this.fact,this.triggers[e]);case"scroll":return new _a(this.launcher,this.fact,this.triggers[e]);case"timed":return new wa(this.launcher,this.fact,this.triggers[e]);default:return null}}}class Sa{constructor(e,t){F(this,"triggers",{});F(this,"appContext",H.getInstance());F(this,"store",this.appContext.getState("app-state"));F(this,"data",this.appContext.getState("data"));this.launcher=e,this.fact=t,this.setUpStoreTriggers()}setUpStoreTriggers(){const e=this.data.triggers;this.store.setState(t=>({...t,store:{...t.store,triggers:e}})),this.triggers=e}create(){const e=Object.keys(this.triggers);if(ee(e))return;new Ea(e,this.launcher,this.fact,this.triggers).create()}}class It{constructor(e){F(this,"appContext",H.getInstance());this.data=e,this.setUpAppContext()}async create(){const e=new ga,t=await e.launch(),n=new ha;return n.create(),new Sa(e,n).create(),t}setUpAppContext(){var e,t;this.appContext.setState("app-state",Ut(((t=(e=this.data)==null?void 0:e.my_account)==null?void 0:t.id)||"rtl-camp")),this.appContext.setState("data",this.data)}}async function Pa(r){const e=r;if(Array.isArray(e==null?void 0:e.campaigns)){let t;e.campaigns.forEach(async(n,a)=>(console.log({d:n}),t={...t,[`Campaign${a+1}`]:await new It(n).create()})),window.camp=t}else if(!Array.isArray(e)){const t=await new It(e.campaigns).create();window.camp=t}}const Oa=async()=>{try{const r=new qt;await r.initApp(),Pa(r.getPopupData())}catch{console.warn("Error initializing Popup")}};(function(){function r(a,s){for(const u of a)if(u.type==="childList"&&u.addedNodes.length>0&&document.body.querySelector("#rtl-shopify-init")){n(),s.disconnect();return}}const e=new MutationObserver((a,s)=>{r(a,s)}),t={childList:!0,subtree:!0};e.observe(document,t);async function n(){await Oa()}})()})();
